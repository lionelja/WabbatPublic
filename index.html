import { Component, OnInit, signal, computed, ChangeDetectionStrategy, ViewChild, ElementRef, AfterViewInit } from '@angular/core';
import { CommonModule, CurrencyPipe, TitleCasePipe } from '@angular/common';
import { FormsModule, ReactiveFormsModule } from '@angular/forms';
import { DragDropModule, CdkDragDrop, moveItemInArray, CdkDragMove } from '@angular/cdk/drag-drop';
import { initializeApp } from 'firebase/app';
import { getAuth, Auth } from 'firebase/auth';
import { getFirestore, DocumentData } from 'firebase/firestore'; 

// --- Global Context Variables (Defined by Canvas Environment) ---
declare const __app_id: string;
declare const __firebase_config: string;

// --- Interface Definitions ---

interface License {
    type: 'Free' | 'Basic' | 'Professional' | 'Enterprise';
    price: number;
    features: string[];
    canSort: boolean;
    canUseEngine: boolean;
    canUseApi: boolean;
}

interface LicenseAssignment {
    seatId: number;
    email: string;
    licenseType: License['type'];
}

interface UserProfile {
    userId: string;
    accountId: string;
    organizationName: string;
    name: string;
    email: string;
    isAdmin: boolean;
    licenseType: License['type'];
    licenseExpires: number; // Unix timestamp
    assignedLicenses: LicenseAssignment[];
    apiBaseUrl: string;
    apiAuthToken: string;
    apiEnvironment: string;
}

interface AuthState {
    isAuthenticated: boolean;
    isAuthReady: boolean;
    error: string | null;
    currentView: 'landing' | 'register' | 'login' | 'app' | 'contact' | 'relational-crts';
    name: string;
    email: string;
    password: string;
    organizationName: string;
    selectedLicenseType: License['type'];
    licensesToPurchase: number;
    licenseEmails: { email: string, licenseType: License['type'] }[];
    isAdditionalPurchase: boolean;
}

interface DataRow extends DocumentData {
    id: string;
    [key: string]: any;
}

interface ColumnConfig {
    name: string;
    isVisible: boolean;
    isUniqueKey: boolean;
    isSortAsc: boolean | null; // true for ASC, false for DESC, null for none
    sortOrder: number; // 0 for primary sort, 1 for secondary, etc.
}

interface RuleCondition {
    column: string;
    operator: string;
    value: string;
    logic: 'AND' | 'OR';
}

interface RuleAction {
    targetColumn: string;
    value: string; // Can be a literal value or an algorithm formula
}

interface TransformationRule {
    id: string;
    name: string;
    conditions: RuleCondition[];
    actions: RuleAction[];
}

interface ApiConfig {
    id: string;
    columnName: string;
    apiName: string;
    mapToColumn: string;
}

interface Testimonial {
    id: string;
    userId: string;
    organizationName: string;
    content: string;
    isApproved: boolean;
    timestamp: number;
}

interface DetailModalState {
    isOpen: boolean;
    row: DataRow | null;
    tab: 'detail' | 'api';
    apiResponse: string;
    apiConfig: ApiConfig | null; // Added apiConfig here
}

interface ErDiagramNode {
    id: string;
    type: 'rules' | 'source' | 'target';
    name: string;
    x: number;
    y: number;
    connections: { targetId: string, type: string }[];
}

interface RelationalFile {
    name: string;
    keys: string[];
    data: DataRow[];
    fileId: 'A' | 'B' | 'C'; // Added fileId for easier reference
}

interface RelationshipDefinition {
    id: string;
    mapName: string;
    mapDescription: string;
    
    // Relationship A -> B (Primary Rule Set -> Reference File 1)
    fileAColumn: string;
    fileBColumn: string;
    fileBRelation: '1:1' | '1:M' | 'M:M' | '0:1' | '0:M'; 

    // Relationship B -> C (Reference File 1 -> Reference File 2)
    fileCColumn: string;
    fileCRelation: '1:1' | '1:M' | 'M:M' | '0:1' | '0:M'; 
}

interface ValidationResult {
    status: 'IDLE' | 'OK' | 'ERROR';
    errors: string[];
}

interface WhereUsedMapDetails {
    mapName: string;
    mapDescription: string;
}

// New: Interface for Cascading Detail Modal State
interface CascadingDetailState {
    isOpen: boolean;
    sourceFileId: 'A' | 'B' | 'C';
    sourceColumn: string;
    sourceValue: any;
    
    // Results structure: FileId -> { column: string, rows: DataRow[] }
    linkedData: { [fileId: string]: { column: string, rows: DataRow[] } };
}

// New: Interface for Column Selector Modal State
interface ColumnSelectorState {
    isOpen: boolean;
    fileId: 'A' | 'B' | 'C' | null;
    relationshipIndex: number;
    targetField: 'fileAColumn' | 'fileBColumn' | 'fileCColumn' | null;
    searchTerm: string;
    showAllColumns: boolean;
}


// --- Component Definition ---

    selector: 'app-root',
    imports: [CommonModule, CurrencyPipe, TitleCasePipe, FormsModule, ReactiveFormsModule, DragDropModule],
    template: `
        <div class="app-container">

            <!-- Global Loading and Custom Modal -->
            <div *ngIf="isLoading()" class="modal-overlay">
                <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-700 font-medium">{{ loadingMessage() }}</span>
                </div>
            </div>

            <!-- PAYMENT MODAL -->
            <div *ngIf="paymentModalOpen()" class="modal-overlay">
                <div class="payment-modal-content max-w-xl w-full">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-6">Complete Purchase: {{ selectedLicenseDetails().type }} License(s)</h2>

                    <!-- License Summary -->
                    <div class="p-4 bg-indigo-50 rounded-lg mb-6 border border-indigo-200">
                        <p class="text-lg font-medium text-indigo-800 mb-1">
                            Organization: <span class="font-bold">{{ authState().organizationName }}</span>
                        </p>
                        <p class="text-lg font-medium text-indigo-800">
                            Licenses Purchased: <span class="font-bold">{{ licensesToPurchase() }}</span>
                        </p>
                        <p class="text-2xl font-extrabold text-indigo-800">
                            Total Price: {{ selectedLicenseDetails().price * licensesToPurchase() | currency:'USD':'symbol':'1.2-2' }}
                        </p>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Payment Information (Mock)</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="visa" name="paymentOption" [value]="'Visa'" checked class="text-indigo-600 focus:ring-indigo-500">
                            <label for="visa" class="flex items-center text-gray-700 font-medium">
                                <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                Visa / Mastercard
                            </label>
                            <input type="radio" id="paypal" name="paymentOption" [value]="'PayPal'" class="text-indigo-600 focus:ring-indigo-500">
                            <label for="paypal" class="flex items-center text-gray-700 font-medium">
                                <svg class="w-6 h-6 mr-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.001 0C6.398 0 1.996 4.477 1.996 9.998c0 5.097 3.522 9.349 8.243 9.873.601.109.822-.262.822-.582 0-.287-.011-1.045-.017-2.051-3.411.75-4.131-1.642-4.131-1.642-.558-1.411-1.36-1.788-1.36-1.788-1.11-.758.083-.742.083-.742 1.226.086 1.874 1.261 1.874 1.261 1.088 1.866 2.859 1.326 3.549 1.015.11-.787.426-1.326.775-1.631-2.716-.307-5.583-1.358-5.583-6.03 0-1.33.475-2.421 1.251-3.275-.125-.308-.542-1.549.119-3.23 0 0 1.018-.328 3.332 1.258a11.53 11.53 0 013.064-.413c1.03.003 2.062.139 3.064.413 2.313-1.586 3.332-1.258 3.332-1.258.662 1.681.246 2.922.12 3.23.774.854 1.25 1.944 1.25 3.275 0 4.683-2.87 5.72-5.59 6.022.44.38.835 1.102.835 2.22 0 1.604-.015 2.894-.015 3.292 0 .32.222.696.829.579C19.479 19.347 23 15.095 23 9.998 23 4.477 18.598 0 12.001 0z"/></svg>
                                PayPal
                            </label>
                        </div>
                        <input type="text" placeholder="Card Number (Mock)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <div class="flex space-x-4">
                            <input type="text" placeholder="MM/YY (Mock)" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="text" placeholder="CVC (Mock)" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-between space-x-4">
                        <button (click)="paymentModalOpen.set(false)" class="px-6 py-3 border border-gray-300 rounded-lg font-bold text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                        <button 
                            (click)="processPaymentAndRegister()" 
                            class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition">
                            Finalize Purchase & Get Access
                        </button>
                    </div>
                </div>
            </div>

            <!-- DETAIL / REST API MODAL -->
            <div *ngIf="detailModal().isOpen" class="modal-overlay">
                <div class="detail-modal-content max-w-2xl w-full">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">Row Detail Viewer (ID: {{ detailModal().row?.id }})</h2>
                    
                    <!-- Tabs -->
                    <ul class="flex flex-wrap -mb-px">
                        <li class="mr-2">
                            <button (click)="setDetailModalTab('detail')"
                                [class]="{
                                    'inline-block p-4 border-b-2': true,
                                    'text-indigo-600 border-indigo-600 font-semibold': detailModal().tab === 'detail',
                                    'border-transparent hover:text-gray-600 hover:border-gray-300': detailModal().tab !== 'detail'
                                }">
                                Data Fields
                            </button>
                        </li>
                        <li class="mr-2">
                            <button (click)="setDetailModalTab('api')"
                                [class]="{
                                    'inline-block p-4 border-b-2': true,
                                    'text-indigo-600 border-indigo-600 font-semibold': detailModal().tab === 'api',
                                    'border-transparent hover:text-gray-600 hover:border-gray-300': detailModal().tab !== 'api'
                                }">
                                REST API Lookup
                            </button>
                        </li>
                    </ul>

                    <div class="p-4 border border-gray-200 rounded-b-lg mt-0 bg-white">
                        <!-- Detail Tab Content -->
                        <div *ngIf="detailModal().row as row">
                            <div *ngFor="let col of visibleColumns()" class="flex justify-between py-1 border-b border-gray-100">
                                <span class="font-medium text-gray-600">{{ col.name }}:</span>
                                <span class="text-gray-800">{{ row[col.name] }}</span>
                            </div>
                        </div>

                        <!-- API Tab Content -->
                        <div *ngIf="detailModal().tab === 'api'" class="space-y-4">
                            <select 
                                name="apiLookupColumn"
                                [value]="detailModal().apiConfig?.columnName || ''" 
                                (change)="setApiLookupColumn($event.target.value)"
                                class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                <option value="" disabled>Select Column for API Lookup...</option>
                                <option *ngFor="let config of apiConfigList()" [value]="config.columnName">
                                    {{ config.columnName }} (via API: {{ config.apiName }})
                                </option>
                            </select>

                            <div *ngIf="detailModal().apiConfig" class="p-3 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                                API: **{{ detailModal().apiConfig.apiName }}** | Value to Send: **{{ detailModal().row ? detailModal().row[detailModal().apiConfig.columnName] : 'N/A' }}**
                            </div>

                            <button 
                                (click)="runSingleRowApiLookup()" 
                                [disabled]="isLoading()"
                                class="w-full py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition disabled:opacity-50">
                                Run API Lookup
                            </button>

                            <div *ngIf="detailModal().apiResponse" class="mt-4">
                                <h4 class="font-semibold text-gray-700 mb-2">API Response (JSON):</h4>
                                <pre class="bg-gray-100 p-3 rounded-lg overflow-x-auto text-sm max-h-60">{{ detailModal().apiResponse }}</pre>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-right">
                        <button (click)="closeDetailModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-bold text-gray-700 hover:bg-gray-100 transition">Close</button>
                    </div>
                </div>
            </div>
            
            <!-- BULK API RESULT MODAL -->
            <div *ngIf="bulkApiModalOpen()" class="modal-overlay">
                <div class="detail-modal-content max-w-4xl w-full">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">Batch API Results ({{ bulkApiResults().length }} Results)</h2>
                    
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <div *ngIf="!bulkApiResults().length" class="p-4 bg-yellow-100 rounded-lg text-yellow-800">No batch API results available.</div>

                        <div *ngFor="let result of bulkApiResults(); let i = index" 
                             class="p-4 border border-gray-300 rounded-lg shadow-sm bg-white">
                            <h3 class="font-bold text-lg text-indigo-700 mb-2">Result for Value: "{{ result.inputValue }}" (Row ID: {{ result.rowId }})</h3>
                            <pre class="bg-gray-50 p-3 rounded-lg overflow-x-auto text-sm max-h-40">{{ result.responseJson }}</pre>
                        </div>
                    </div>

                    <div class="mt-6 text-right">
                        <button (click)="bulkApiModalOpen.set(false)" class="px-6 py-3 border border-gray-300 rounded-lg font-bold text-gray-700 hover:bg-gray-100 transition">Close All Results</button>
                    </div>
                </div>
            </div>
            
            <!-- CASCADING DETAIL MODAL (NEW) -->
            <div *ngIf="cascadingDetail().isOpen" class="modal-overlay">
                <div class="cascading-modal-content w-full">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">
                        Cascading Dependency Trace
                    </h2>
                    <p class="text-gray-600 mb-6">
                        Tracing dependencies based on **{{ cascadingDetail().sourceColumn }}** with value: 
                        <span class="font-extrabold text-indigo-800">"{{ cascadingDetail().sourceValue }}"</span> 
                        from **File {{ cascadingDetail().sourceFileId }}**.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Linked File B Details (Reference 1) -->
                        <div class="space-y-4 p-4 rounded-lg" [ngClass]="{'bg-yellow-50': cascadingDetail().linkedData['B'], 'bg-gray-100': !cascadingDetail().linkedData['B']}">
                            <h3 class="text-xl font-semibold text-yellow-800 border-b border-yellow-300 pb-2">
                                File B: {{ whereUsedFiles().B.name }}
                            </h3>
                            <div *ngIf="cascadingDetail().linkedData['B'] as linkedB">
                                <p class="text-sm font-medium text-gray-700 mb-2">
                                    Linked by column: **{{ linkedB.column }}** (Found {{ linkedB.rows.length }} records)
                                </p>
                                <div class="max-h-60 overflow-y-auto border border-yellow-200 rounded-lg">
                                    <table class="w-full small-grid">
                                        <thead>
                                            <tr class="bg-yellow-100 sticky top-0">
                                                <th *ngFor="let key of whereUsedFiles().B.keys" class="p-2 border-b">{{ key }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let row of linkedB.rows" class="border-b">
                                                <td *ngFor="let key of whereUsedFiles().B.keys" class="p-2">{{ row[key] }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div *ngIf="!cascadingDetail().linkedData['B']" class="text-center text-gray-500 py-4">
                                No direct link found in File B for selected value.
                            </div>
                        </div>

                        <!-- Linked File C Details (Reference 2) -->
                        <div class="space-y-4 p-4 rounded-lg" [ngClass]="{'bg-red-50': cascadingDetail().linkedData['C'], 'bg-gray-100': !cascadingDetail().linkedData['C']}">
                            <h3 class="text-xl font-semibold text-red-800 border-b border-red-300 pb-2">
                                File C: {{ whereUsedFiles().C.name }}
                            </h3>
                            <div *ngIf="cascadingDetail().linkedData['C'] as linkedC">
                                <p class="text-sm font-medium text-gray-700 mb-2">
                                    Linked by column: **{{ linkedC.column }}** (Found {{ linkedC.rows.length }} records)
                                </p>
                                <div class="max-h-60 overflow-y-auto border border-red-200 rounded-lg">
                                    <table class="w-full small-grid">
                                        <thead>
                                            <tr class="bg-red-100 sticky top-0">
                                                <th *ngFor="let key of whereUsedFiles().C.keys" class="p-2 border-b">{{ key }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let row of filteredFileC()" class="border-b">
                                                <td *ngFor="let key of whereUsedFiles().C.keys" class="p-2">{{ row[key] }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div *ngIf="!cascadingDetail().linkedData['C']" class="text-center text-gray-500 py-4">
                                No direct link found in File C for selected value.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-right">
                        <button (click)="closeCascadingDetailModal()" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">Close Trace</button>
                    </div>
                </div>
            </div>
            
            <!-- COLUMN SELECTION MODAL (NEW) -->
            <div *ngIf="columnSelector().isOpen" class="modal-overlay">
                <div class="column-selector-modal-content w-full">
                    <h2 class="text-2xl font-bold text-indigo-600 mb-4">
                        Select Column for File {{ columnSelector().fileId }}
                    </h2>
                    <p class="text-gray-600 mb-4">
                        Choose the column that serves as the **Link Key** for this file.
                    </p>

                    <!-- Search Input -->
                    <input 
                        type="text" 
                        placeholder="Search column names..." 
                        [value]="columnSelector().searchTerm" 
                        (input)="updateColumnSelectorSearch($event.target.value)"
                        class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 mb-4"
                    >

                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        
                        <div *ngIf="filteredLikelyUsedColumns().length > 0">
                            <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1">Likely Used Columns (100% Data Coverage)</h3>
                            <div *ngFor="let col of filteredLikelyUsedColumns()">
                                <div 
                                    [class]="'column-list-item ' + (isColumnSelected(col) ? 'selected' : '')"
                                    (click)="selectColumnFromList(col)">
                                    {{ col }}
                                </div>
                            </div>
                        </div>

                        <div *ngIf="columnSelector().showAllColumns || filteredLessLikelyColumns().length > 0">
                            <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1 mt-4">Less Likely Columns (Partial Data Coverage)</h3>
                            <div *ngFor="let col of filteredLessLikelyColumns()">
                                <div 
                                    [class]="'column-list-item less-likely ' + (isColumnSelected(col) ? 'selected' : '')"
                                    (click)="selectColumnFromList(col)">
                                    {{ col }}
                                </div>
                            </div>
                        </div>

                        <div *ngIf="!columnSelector().showAllColumns && allColumns().length > filteredLikelyUsedColumns().length">
                             <button (click)="toggleShowAllColumns(true)" class="w-full py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition mt-4">
                                Show All Columns ({{ allColumns().length }} total)
                            </button>
                        </div>
                        
                        <div *ngIf="filteredLikelyUsedColumns().length === 0 && filteredLessLikelyColumns().length === 0" class="p-4 bg-yellow-100 rounded-lg text-yellow-800 text-center">
                            No columns match the search term "{{ columnSelector().searchTerm }}".
                        </div>
                    </div>

                    <div class="mt-6 text-right">
                        <button (click)="closeColumnSelectorModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-bold text-gray-700 hover:bg-gray-100 transition">Cancel</button>
                    </div>
                </div>
            </div>


            <!-- HEADER -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-20">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-extrabold text-indigo-800 tracking-tight">ConfigFlow</h1>
                    <span class="text-sm text-gray-500 hidden sm:inline">Configuration Manager for UKG PRO WFM</span>
                </div>
                
                <div *ngIf="isAppView()" class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 font-medium hidden sm:inline">
                        User: {{ currentProfile().email }} ({{ currentProfile().licenseType }})
                    </span>
                    <!-- LOGOUT FUNCTIONALITY KEPT FOR STATE RESET -->
                    <button (click)="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition text-sm font-semibold">
                        Logout
                    </button>
                </div>
                
                <div *ngIf="isLandingView() || isAuthView() || isContactView()" class="flex items-center space-x-4 text-sm font-medium">
                    <!-- FIX: Ensure navigation uses the navigateTo method correctly -->
                    <button (click)="navigateTo('landing')" class="text-indigo-600 hover:text-indigo-800 transition">About ConfigFlow</button>
                    <button (click)="navigateTo('contact')" class="text-indigo-600 hover:text-indigo-800 transition">Contact Us</button>
                </div>
            </header>

            <!-- LANDING PAGE -->
            <div *ngIf="isLandingView()" class="p-8 flex-grow">
                <div class="max-w-6xl mx-auto space-y-12">
                    <!-- Hero Section -->
                    <div class="flex flex-col lg:flex-row items-center bg-white p-10 rounded-2xl shadow-xl space-y-8 lg:space-y-0 lg:space-x-12">
                        <div class="lg:w-1/2 space-y-6">
                            <h2 class="text-5xl font-extrabold text-gray-900 leading-tight">
                                The UKG WFM Efficiency Layer. Achieve 80% Faster Config Edits with <span class="text-indigo-600">ConfigFlow Rule Sets</span>
                            </h2>
                            <p class="text-xl text-gray-600">
                                **ConfigFlow** acts as a **strategic accelerator** for UKG WFM maintenance. We minimize high-volume, low-value work by moving beyond the native one-at-a-time modifications, empowering your team to manage complex configuration data quickly, accurately, and with full confidence.
                            </p>
                            <h3 class="2xl font-bold text-indigo-700 pt-4">The ConfigFlow Maintenance Cycle:</h3>
                            
                            <!-- Flow Diagram Container -->
                            <div class="flow-wrapper relative">
                                
                                <!-- Step 1: IMPORT (Top Center - Grid Col 4) -->
                                <div class="flow-step-vertical" style="grid-column: 4; grid-row: 1;">
                                    <div class="flow-box">1. Import SDM File</div>
                                </div>
                                
                                <!-- Step 2: DEFINE/READ (Top Left - Grid Col 1) -->
                                <div class="flow-step-vertical" style="grid-column: 7; grid-row: 2;">
                                    <div class="flow-box">2. Define/Read Edit Rules</div>
                                </div>
                                
                                <!-- Step 3: RUN (Bottom Center - Grid Col 4) -->
                                <div class="flow-step-vertical" style="grid-column: 4; grid-row: 3;">
                                    <div class="flow-box">3. Run Engine</div>
                                </div>
                                
                                <!-- Step 4: EXPORT (Top Right - Grid Col 7) -->
                                <div class="flow-step-vertical" style="grid-column: 1; grid-row: 2;">
                                    <div class="flow-box">4. Export SDM File</div>
                                </div>

                                <!-- SVG Definitions for Arrows (Desktop Only) -->
                                <svg class="erd-svg svg-flow-desktop hidden lg:block" width="100%" height="100%" style="grid-column: 1 / span 7; grid-row: 1 / span 3; overflow: visible;">
                                    <defs>
                                        <marker id="arrowhead-flow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                                            <polygon points="0 0, 10 5, 0 10" fill="#4f46e5" />
                                        </marker>
                                    </defs>
                                    
                                    <!-- 1. IMPORT (4,1) -> DEFINE/READ (7,2) -->
                                    <path d="M 47% 10% C 65% 10%, 80% 30%, 85% 45%" stroke="#4f46e5" stroke-width="3" fill="none" marker-end="url(#arrowhead-flow)" />
                                    
                                    <!-- 2. DEFINE/READ (7,2) -> RUN (4,3) -->
                                    <path d="M 85% 55% C 80% 70%, 65% 90%, 53% 90%" stroke="#4f46e5" stroke-width="3" fill="none" marker-end="url(#arrowhead-flow)" />
                                    
                                    <!-- 3. RUN (4,3) -> EXPORT (1,2) -->
                                    <path d="M 47% 90% C 30% 90%, 15% 70%, 15% 55%" stroke="#4f46e5" stroke-width="3" fill="none" marker-end="url(#arrowhead-flow)" />
                                    
                                    <!-- 4. EXPORT (1,2) -> IMPORT (4,1) (Cycle) -->
                                    <path d="M 15% 45% C 20% 30%, 35% 10%, 47% 10%" stroke="#4f46e5" stroke-width="3" fill="none" marker-end="url(#arrowhead-flow)" />
                                </svg>

                                <!-- Simple Stacked Mobile Flow (Mobile Only) -->
                                <div class="flow-diagram-wrapper lg:hidden">
                                    <div class="flow-box" style="width: 100%;">1. Import SDM File</div>
                                    <div class="arrow-vertical-down"></div>
                                    <div class="flow-box" style="width: 100%;">2. Define/Read Edit Rules</div>
                                    <div class="arrow-vertical-down"></div>
                                    <div class="flow-box" style="width: 100%;">3. Run Transformation Engine</div>
                                    <div class="arrow-vertical-down"></div>
                                    <div class="flow-box" style="width: 100%;">4. Export SDM File</div>
                                </div>
                            </div>
                            
                            <div class="pt-4 space-x-4">
                                <button (click)="navigateTo('login')" class="px-8 py-3 bg-indigo-600 text-white text-lg font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">
                                    Login
                                </button>
                                <button (click)="navigateTo('register')" class="px-8 py-3 bg-gray-200 text-indigo-600 text-lg font-bold rounded-lg shadow-lg hover:bg-gray-300 transition transform hover:scale-105">
                                    Register Now
                                </button>
                            </div>
                        </div>
                        <div class="lg:w-1/2 flex justify-center">
                            <img src="https://placehold.co/600x350/a5b4fc/ffffff?text=ConfigFlow+App+Interface+GIF" alt="ConfigFlow+App+Interface+GIF" class="rounded-xl shadow-2xl border-4 border-indigo-200" onerror="this.onerror=null;this.src='https://placehold.co/600x350/a5b4fc/ffffff?text=ConfigFlow+App+Interface+GIF';" />
                        </div>
                    </div>

                    <!-- Promo & Licensing Section -->
                    <div class="bg-indigo-700 p-8 rounded-2xl text-white shadow-xl">
                        <h3 class="text-3xl font-bold mb-3 text-yellow-300">
                            ðŸš¨ Post-Aspire 2025 Special!
                        </h3>
                        <p class="text-xl font-semibold mb-6">
                            Purchase one license and **get five licenses free**! Promotion ends 12/31/2025.
                        </p>

                        <h3 class="text-3xl font-bold mb-6 border-b border-indigo-400 pb-2">Licensing Options</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <!-- License Card: Free -->
                            <div class="bg-white text-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-gray-400">
                                <h4 class="text-2xl font-bold mb-2">Free</h4>
                                <p class="text-4xl font-extrabold mb-4">$0.00</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Data Grid & Sort</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>File Import/Export (JSON)</li>
                                    <li class="flex items-center text-red-500"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>IF/THEN Engine</li>
                                </ul>
                            </div>
                            <!-- License Card: Basic -->
                            <div class="bg-white text-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                                <h4 class="text-2xl font-bold mb-2">Basic</h4>
                                <p class="text-4xl font-extrabold mb-4">$299.99/yr</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Data Grid & Sort</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Row Insert/Replicate</li>
                                    <li class="flex items-center text-red-500"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>IF/THEN Engine</li>
                                </ul>
                            </div>
                            <!-- License Card: Professional -->
                            <div class="bg-white text-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                                <h4 class="text-2xl font-bold mb-2">Professional</h4>
                                <p class="text-4xl font-extrabold mb-4">$499.99/yr</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>IF/THEN Engine</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Rule Library Save/Load</li>
                                    <li class="flex items-center text-red-500"><svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>REST API Connection</li>
                                </ul>
                            </div>
                            <!-- License Card: Enterprise -->
                            <div class="bg-white text-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                                <h4 class="text-2xl font-bold mb-2">Enterprise</h4>
                                <p class="text-4xl font-extrabold mb-4">$999.99/yr</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>IF/THEN Engine</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Where Used Search</li>
                                    <li class="flex items-center"><svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>SSO & REST API</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Testimonials Section -->
                    <div class="space-y-6">
                        <h3 class="text-3xl font-bold text-gray-800 border-b pb-2">What Customers Say</h3>
                        <div *ngIf="approvedTestimonials().length > 0" class="testimonial-carousel">
                            <div *ngFor="let t of approvedTestimonials()" class="testimonial-card">
                                <p class="text-gray-700 italic mb-4">"{{ t.content }}"</p>
                                <p class="font-semibold text-indigo-600">â€” {{ t.organizationName }}</p>
                            </div>
                        </div>
                        <div *ngIf="approvedTestimonials().length === 0" class="p-4 bg-gray-100 rounded-lg text-gray-600">
                            Be the first to leave a testimonial!
                        </div>
                    </div>

                    <!-- Footer / Legal -->
                    <footer class="text-center text-sm text-gray-500 pt-8 border-t border-gray-200">
                        <p>&copy; 2024 ConfigFlow Configuration Manager. All rights reserved.</p>
                        <p>SSO sign-in requires Enterprise license and existing corporate identity management integration.</p>
                    </footer>
                </div>
            </div>

            <!-- CONTACT PAGE -->
            <div *ngIf="isContactView()" class="p-8 flex-grow">
                <div class="flex-grow flex items-center justify-center">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg">
                        <h2 class="text-3xl font-bold text-indigo-600 mb-4">Contact Our Sales Team</h2>
                        <p class="text-gray-600 mb-6">Interested in transforming your UKG WFM maintenance cycle? Reach out to schedule a demo or inquire about licensing.</p>

                        <div class="space-y-6">
                            <div class="p-4 bg-indigo-50 rounded-lg">
                                <h3 class="font-bold text-indigo-800 mb-2">General Sales & Inquiries</h3>
                                <p class="text-indigo-700">Email: <a href="mailto:sales@configflow.com" class="font-semibold hover:underline">sales@configflow.com</a></p>
                                <p class="text-indigo-700">Phone: (888) CONFIG-FLOW</p>
                            </div>

                            <form class="space-y-4" (ngSubmit)="contactSubmit()">
                                <input type="text" placeholder="Your Name" name="contactName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="email" placeholder="Work Email" name="contactEmail" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <textarea placeholder="Tell us about your UKG maintenance challenge..." name="contactMessage" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                
                                <button 
                                    type="submit" 
                                    class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
                                    Send Inquiry
                                </button>
                            </form>
                            <p *ngIf="contactMessageStatus()" class="mt-4 text-center text-sm font-semibold" [ngClass]="{'text-green-600': contactMessageStatus() === 'Sent!', 'text-red-600': contactMessageStatus() !== 'Sent!'}">
                                {{ contactMessageStatus() }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- LOGIN/REGISTER PAGE -->
            <div *ngIf="isAuthView()" class="flex-grow flex items-center justify-center p-4">
                <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-2">{{ isLoginView() ? 'Sign In to ConfigFlow' : (authState().isAdditionalPurchase ? 'Purchase Additional Licenses' : 'New Account Registration') }}</h2>
                    <p class="text-gray-500 mb-6">{{ isLoginView() ? 'Enter your credentials to access the tool.' : 'Secure your licenses and complete your account setup.' }}</p>

                    <!-- Using [value] and (input)/(change) to bypass problematic NgModel resolution -->
                    <form (ngSubmit)="handleAuthSubmit()">
                        <div *ngIf="authState().error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span class="block sm:inline">{{ authState().error }}</span>
                        </div>

                        <!-- Registration Fields (Non-Admin users skip these) -->
                        <div *ngIf="isRegisterView() && !authState().isAdditionalPurchase" class="space-y-4 mb-6">
                            <input type="text" placeholder="Your Full Name (Admin)" name="name" [value]="authState().name" (input)="updateAuthField('name', $event.target.value)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="text" placeholder="Organization Name" name="orgName" [value]="authState().organizationName" (input)="updateAuthField('organizationName', $event.target.value)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <select name="selectedLicenseType" [value]="authState().selectedLicenseType" (change)="updateLicenseDetails($event.target.value)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="" disabled>Select License Type...</option>
                                <option *ngFor="let key of licenseTypes()" [value]="key">{{ getLicenseOptionText(key) }}</option>
                            </select>
                            
                            <input type="number" name="licensesToPurchase" [value]="authState().licensesToPurchase" (input)="updateLicensesToPurchase($event.target.value)" [min]="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <label class="font-semibold text-sm text-indigo-800">License 1 (Admin Seat)</label>
                                <input type="email" placeholder="Primary Admin Email" name="email" [value]="authState().email" (input)="updateAuthField('email', $event.target.value)" required class="w-full p-2 mt-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" [disabled]="!!authState().isAdditionalPurchase">
                                <input type="hidden" [value]="authState().selectedLicenseType" name="adminLicenseType">
                            </div>
                        </div>

                        <!-- Additional Purchase Fields -->
                        <div *ngIf="isRegisterView() && authState().isAdditionalPurchase" class="space-y-4 mb-6">
                            <h3 class="text-xl font-semibold text-gray-700">Licenses to Purchase:</h3>
                            <input type="number" name="licensesToPurchase" [value]="authState().licensesToPurchase" (input)="updateLicensesToPurchase($event.target.value)" [min]="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <!-- Email and Password Fields (Common to both) -->
                        <div class="space-y-4 mb-6">
                            <!-- Show primary email if not additional purchase, otherwise just show secondary licenses -->
                            <div *ngIf="isLoginView()" class="space-y-2">
                                <label class="font-medium text-gray-700 text-sm">Email Address</label>
                                <input 
                                    name="loginEmail"
                                    type="email" 
                                    placeholder="Your Login Email" 
                                    [value]="authState().email" 
                                    (input)="updateAuthField('email', $event.target.value)"
                                    required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                >
                            </div>

                            <!-- License assignment for secondary licenses during registration/purchase -->
                            <div *ngFor="let license of licensesToPurchaseArray(); let i = index" class="space-y-2">
                                <label class="font-medium text-gray-700 text-sm">Seat {{ license.seatIndex }}: Email Address</label>
                                <input 
                                    [name]="'licenseEmail_' + license.seatIndex"
                                    type="email" 
                                    [placeholder]="'Seat ' + license.seatIndex + ' Email Address'" 
                                    [value]="licenseEmails()[i].email" 
                                    (input)="updateLicenseEmail(i, 'email', $event.target.value)"
                                    required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                >
                                <!-- License Type Radio Buttons -->
                                <div class="flex flex-wrap items-center space-x-3 mt-1">
                                    <span class="text-sm font-medium text-gray-500 mr-2">License:</span>
                                    <div *ngFor="let type of licenseTypes()" class="flex items-center">
                                        <input 
                                            [id]="'seat' + license.seatIndex + '-' + type" 
                                            [name]="'licenseType_' + license.seatIndex" 
                                            type="radio" 
                                            [value]="type"
                                            [checked]="licenseEmails()[i].licenseType === type"
                                            (change)="updateLicenseEmail(i, 'licenseType', $event.target.value)"
                                            class="w-4 h-4 text-indigo-600 focus:ring-indigo-500"
                                            [required]="true"
                                        >
                                        <label [for]="'seat' + license.seatIndex + '-' + type" class="ml-1 text-sm font-medium text-gray-700">{{ type }}</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Password Field -->
                            <input type="password" placeholder="Password" name="password" [value]="authState().password" (input)="updateAuthField('password', $event.target.value)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <button 
                            type="submit" 
                            class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50">
                            {{ isLoginView() ? 'Sign In' : 'Complete Registration & Purchase' }}
                        </button>
                    </form>

                    <div class="mt-6 text-center text-sm">
                        <button *ngIf="isLoginView()" (click)="navigateTo('register')" class="text-indigo-600 hover:text-indigo-800 font-semibold">
                            Need an account? Register Now
                        </button>
                        <button *ngIf="isRegisterView()" (click)="navigateTo('login')" class="text-indigo-600 hover:text-indigo-800 font-semibold">
                            Already registered? Sign In
                        </button>
                    </div>
                </div>
            </div>

            <!-- MAIN APPLICATION VIEW -->
            <div *ngIf="isAppView()" class="flex-grow p-4 bg-white shadow-inner">
                
                <!-- Tab Navigation -->
                <nav class="border-b border-gray-200 mb-4">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <li class="mr-2">
                            <button (click)="mainTab.set('my-profile')" [class]="tabClass('my-profile')">My Profile</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('data-grid')" [class]="tabClass('data-grid')">Rule Set (Data) ({{ dataRows().length }} rows)</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('engine')" [class]="tabClass('engine')">Edit Engine</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('api-config')" [class]="tabClass('api-config')">API Cross-Reference</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('org-admin')" [class]="tabClass('org-admin')">License Admin</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('where-used')" [class]="tabClass('where-used')">Where Used?</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('relational-crts')" [class]="tabClass('relational-crts')">Relational CRTs</button>
                        </li>
                        <li class="mr-2">
                            <button (click)="mainTab.set('support')" [class]="tabClass('support')">Support & Feedback</button>
                        </li>
                    </ul>
                </nav>

                <!-- Tab Content -->
                <div class="grid-tab-content">
                    
                    <!-- My Profile Tab -->
                    <div *ngIf="mainTab() === 'my-profile'" class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">My Profile Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl border">
                            <div><span class="font-semibold text-gray-600">Full Name:</span> <span class="font-bold text-gray-800">{{ currentProfile().name }}</span></div>
                            <div><span class="font-semibold text-gray-600">Primary Email:</span> <span class="font-bold text-gray-800">{{ currentProfile().email }}</span></div>
                            <div><span class="font-semibold text-gray-600">User ID:</span> <span class="font-bold text-gray-800 break-all">{{ currentProfile().userId }}</span></div>
                            <div><span class="font-semibold text-gray-600">Assigned License:</span> <span [class]="'font-bold ' + licenseColor(currentProfile().licenseType)">{{ currentProfile().licenseType }}</span></div>
                        </div>
                    </div>

                    <!-- Organization Admin Tab -->
                    <div *ngIf="mainTab() === 'org-admin'" class="space-y-8">
                        <h2 class="text-3xl font-bold text-indigo-800">License Administration</h2>
                        
                        <!-- Account Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-indigo-50 p-6 rounded-xl border border-indigo-200">
                            <div><span class="font-semibold text-indigo-700">Account ID:</span> <span class="font-bold text-indigo-900">{{ currentProfile().accountId }}</span></div>
                            <div><span class="font-semibold text-indigo-700">Organization:</span> <span class="font-bold text-indigo-900">{{ currentProfile().organizationName }}</span></div>
                            <div><span class="font-semibold text-indigo-700">Licenses:</span> <span class="font-bold text-indigo-900">{{ currentProfile().assignedLicenses.length }} / {{ currentProfile().assignedLicenses.length }} Assigned</span></div>
                        </div>

                        <!-- License Management -->
                        <div class="space-y-4 p-6 bg-white rounded-xl shadow">
                            <div class="flex justify-between items-center border-b pb-2 mb-4">
                                <h3 class="font-semibold text-gray-700 text-xl">Assigned Licenses</h3>
                                <button (click)="handlePurchaseMoreLicenses()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition text-sm font-semibold">
                                    Purchase More Licenses
                                </button>
                            </div>
                            <table class="w-full text-left org-admin-grid text-sm">
                                <thead>
                                    <tr>
                                        <th class="w-16">Seat</th>
                                        <th class="w-1/3">Email Address</th>
                                        <th class="w-1/4">License Type</th>
                                        <th class="w-1/4">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let license of currentProfile().assignedLicenses; let i = index" class="border-t">
                                        <td class="font-bold">{{ license.seatId }}</td>
                                        <td class="break-all">{{ license.email }} <span *ngIf="license.email === currentProfile().email" class="text-xs font-semibold px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full ml-2">Admin</span></td>
                                        <td [class]="licenseColor(license.licenseType)">{{ license.licenseType }}</td>
                                        <td>Active</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- API Connection Settings -->
                        <div *ngIf="canUseApi()" class="space-y-4 p-6 bg-white rounded-xl shadow">
                            <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">API Connection Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Base API URL (v2 endpoints)</label>
                                    <input type="text" name="apiBaseUrl" [value]="currentProfile().apiBaseUrl" (input)="updateProfileField('apiBaseUrl', $event.target.value)" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="https://api.ukgpro.com/v2/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Authentication Token (Bearer)</label>
                                    <input type="password" name="apiAuthToken" [value]="currentProfile().apiAuthToken" (input)="updateProfileField('apiAuthToken', $event.target.value)" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter Bearer Token (e.g., JWT)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Environment</label>
                                    <select name="apiEnvironment" [value]="currentProfile().apiEnvironment" (change)="updateProfileField('apiEnvironment', $event.target.value)" class="w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="prod">Production</option>
                                        <option value="staging">Staging</option>
                                        <option value="sandbox">Sandbox/Development</option>
                                    </select>
                                </div>
                            </div>
                            <div class="pt-4">
                                <button (click)="saveProfileChanges()" class="px-6 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition">Save API Config</button>
                            </div>
                        </div>

                        <!-- Testimonial Moderation -->
                        <div class="space-y-4 p-6 bg-white rounded-xl shadow">
                            <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Testimonial Moderation ({{ pendingTestimonials().length }} Pending)</h3>
                            <div *ngIf="!pendingTestimonials().length" class="p-3 bg-green-100 rounded-lg text-green-800">
                                No testimonials pending approval.
                            </div>
                            <div *ngFor="let t of pendingTestimonials()" class="p-3 border border-gray-200 rounded-lg flex justify-between items-center space-x-4">
                                <div>
                                    <p class="italic text-gray-700">"{{ t.content }}"</p>
                                    <p class="text-sm font-medium text-indigo-600">â€” {{ t.organizationName }}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button (click)="approveTestimonial(t.id)" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">Approve</button>
                                    <button (click)="deleteTestimonial(t.id)" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">Reject</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Engine Tab (Formerly IF/THEN) -->
                    <div *ngIf="mainTab() === 'engine'" class="space-y-6 p-4 bg-gray-50 rounded-xl shadow">
                        <h2 class="text-3xl font-bold text-indigo-800">Edit Engine (Rule-Based Transformations)</h2>
                        <p class="text-gray-600">Define logical rules (IF [Condition] THEN [Action]) to automatically update values in the Rule Set Data Grid.</p>

                        <div class="flex flex-wrap items-center space-x-4 border-b pb-4 mb-4">
                            <button (click)="addRule()" [disabled]="columnConfig().length === 0" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition disabled:opacity-50">
                                + Add New Rule
                            </button>
                            <button (click)="applyAllRules()" [disabled]="transformationRules().length === 0 || dataRows().length === 0" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition disabled:opacity-50">
                                Run All Rules ({{ transformationRules().length }})
                            </button>
                            <div class="flex space-x-2 ml-auto">
                                <button (click)="saveRulesToFile()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm">
                                    Export Rules
                                </button>
                                <button (click)="loadRulesFromFile()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm">
                                    Import Rules
                                </button>
                            </div>
                        </div>

                        <div *ngIf="columnConfig().length === 0" class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 font-medium">
                            Please import data into the "Rule Set (Data)" tab before creating rules.
                        </div>

                        <!-- Rule List -->
                        <div *ngFor="let rule of transformationRules(); let ruleIndex = index" class="bg-white p-5 rounded-xl shadow-lg space-y-4 border-l-4 border-indigo-500 relative">
                            <div class="flex justify-between items-start">
                                <input type="text" 
                                    [value]="rule.name" 
                                    (input)="rule.name = $event.target.value"
                                    class="text-xl font-bold text-indigo-700 w-3/4 p-1 border-b border-gray-200 focus:border-indigo-500 outline-none" 
                                    placeholder="Rule Name">
                                <button (click)="removeRule(ruleIndex)" class="text-red-500 hover:text-red-700 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>

                            <!-- Conditions -->
                            <div class="space-y-3 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                <h4 class="font-semibold text-indigo-800">IF Conditions:</h4>
                                <div *ngFor="let cond of rule.conditions; let condIndex = index" class="grid grid-cols-12 gap-2 items-center">
                                    <span class="text-xs font-semibold text-gray-600 col-span-1">{{ condIndex === 0 ? 'IF' : cond.logic }}</span>
                                    
                                    <!-- Column Selector -->
                                    <select [value]="cond.column" (change)="updateRuleCondition(ruleIndex, condIndex, 'column', $event.target.value)" class="col-span-3 p-2 border rounded-lg text-sm">
                                        <option *ngFor="let col of columnConfig()" [value]="col.name">{{ col.name }}</option>
                                    </select>
                                    
                                    <!-- Operator Selector -->
                                    <select [value]="cond.operator" (change)="updateRuleCondition(ruleIndex, condIndex, 'operator', $event.target.value)" class="col-span-2 p-2 border rounded-lg text-sm">
                                        <option *ngFor="let op of ruleOperators" [value]="op.value">{{ op.label }}</option>
                                    </select>
                                    
                                    <!-- Value Input -->
                                    <input type="text" [value]="cond.value" (input)="updateRuleCondition(ruleIndex, condIndex, 'value', $event.target.value)" class="col-span-3 p-2 border rounded-lg text-sm" placeholder="Value or Comma-list">
                                    
                                    <!-- Logic Selector (AND/OR) -->
                                    <select *ngIf="rule.conditions.length > 1 && condIndex < rule.conditions.length - 1"
                                        [value]="cond.logic" 
                                        (change)="updateRuleCondition(ruleIndex, condIndex, 'logic', $event.target.value)" 
                                        class="col-span-2 p-2 border rounded-lg text-sm">
                                        <option value="AND">AND</option>
                                        <option value="OR">OR</option>
                                    </select>
                                    
                                    <!-- Remove Button -->
                                    <button (click)="removeRuleCondition(ruleIndex, condIndex)" class="col-span-1 text-red-500 hover:bg-red-50 p-1 rounded-full">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <button (click)="addRuleCondition(ruleIndex)" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition mt-2 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Add Condition
                                </button>
                            </div>

                            <!-- Actions -->
                            <div class="space-y-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                <h4 class="font-semibold text-green-800">THEN Actions:</h4>
                                <div *ngFor="let action of rule.actions; let actionIndex = index" class="grid grid-cols-12 gap-2 items-center">
                                    <span class="text-xs font-semibold text-gray-600 col-span-1">THEN</span>
                                    
                                    <!-- Target Column -->
                                    <select [value]="action.targetColumn" (change)="updateRuleAction(ruleIndex, actionIndex, 'targetColumn', $event.target.value)" class="col-span-3 p-2 border rounded-lg text-sm">
                                        <option *ngFor="let col of columnConfig()" [value]="col.name">{{ col.name }}</option>
                                    </select>
                                    
                                    <span class="col-span-1 text-center font-bold text-gray-700">=</span>
                                    
                                    <!-- Value / Formula Input -->
                                    <input type="text" [value]="action.value" (input)="updateRuleAction(ruleIndex, actionIndex, 'value', $event.target.value)" class="col-span-6 p-2 border rounded-lg text-sm" placeholder="New Value or {{ColumnName}} Formula">
                                    
                                    <!-- Remove Button -->
                                    <button (click)="removeRuleAction(ruleIndex, actionIndex)" class="col-span-1 text-red-500 hover:bg-red-50 p-1 rounded-full">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                <button (click)="addRuleAction(ruleIndex)" class="text-sm font-medium text-green-600 hover:text-green-800 transition mt-2 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Add Action
                                </button>
                                <p class="text-xs text-gray-500 pt-2">Formula example: `{ EmployeeID } + 100`</p>
                            </div>
                        </div>
                    </div>


                    <!-- API Cross-Reference Tab -->
                    <div *ngIf="mainTab() === 'api-config'" class="space-y-6 p-4 bg-gray-50 rounded-xl shadow">
                        <h2 class="text-3xl font-bold text-indigo-800">API Cross-Reference Manager</h2>
                        <p class="text-gray-600">Configure lookup references to external REST endpoints (Enterprise feature required for API execution).</p>
                        
                        <div class="flex flex-wrap items-center space-x-4 border-b pb-4 mb-4">
                            <button (click)="addApiConfig()" [disabled]="columnConfig().length === 0" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition disabled:opacity-50">
                                + Add New API Config
                            </button>
                            <button (click)="runBulkApiCall()" [disabled]="apiConfigList().length === 0 || dataRows().length === 0" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition disabled:opacity-50">
                                Run Batch Lookup (Mock)
                            </button>
                            <button *ngIf="bulkApiResults().length > 0" (click)="bulkApiModalOpen.set(true)" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition text-sm ml-auto">
                                View {{ bulkApiResults().length }} Batch Results
                            </button>
                        </div>
                        
                         <div *ngIf="columnConfig().length === 0" class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 font-medium">
                            Please import data into the "Rule Set (Data)" tab to define API column mappings.
                        </div>

                        <!-- API Config List -->
                        <div *ngFor="let config of apiConfigList(); let configIndex = index" class="bg-white p-5 rounded-xl shadow-lg space-y-4 border-l-4 border-blue-500 relative">
                            <div class="flex justify-end">
                                <button (click)="removeApiConfig(configIndex)" class="text-red-500 hover:text-red-700 transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Source Column (Value to Send)</label>
                                    <select [value]="config.columnName" (change)="updateApiConfig(configIndex, 'columnName', $event.target.value)" class="w-full p-2 border rounded-lg">
                                        <option *ngFor="let col of columnConfig()" [value]="col.name">{{ col.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Target Column (Field to Map Back)</label>
                                    <select [value]="config.mapToColumn" (change)="updateApiConfig(configIndex, 'mapToColumn', $event.target.value)" class="w-full p-2 border rounded-lg">
                                        <option *ngFor="let col of columnConfig()" [value]="col.name">{{ col.name }}</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">API Endpoint Name (Mock/Path)</label>
                                <input type="text" 
                                    [value]="config.apiName" 
                                    (input)="updateApiConfig(configIndex, 'apiName', $event.target.value)"
                                    class="w-full p-2 border rounded-lg"
                                    placeholder="e.g., GetEmployeeDetails">
                            </div>

                            <p class="text-sm text-gray-500 pt-2">
                                *Double-click any row in the Data Grid tab to test this configuration for a single record.
                            </p>
                        </div>
                    </div>


                    <!-- Support & Feedback Tab -->
                    <div *ngIf="mainTab() === 'support'" class="space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800">Support & Feedback</h2>
                        
                        <!-- Submit Testimonial Form -->
                        <div class="p-6 bg-white rounded-xl shadow space-y-4 border border-gray-200">
                            <h3 class="text-xl font-semibold text-indigo-700">Submit Testimonial</h3>
                            <textarea 
                                name="testimonialContent"
                                [value]="newTestimonialContent"
                                (input)="newTestimonialContent = $event.target.value"
                                rows="4" 
                                placeholder="Share your experience with ConfigFlow (required)" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                            ></textarea>
                            <button 
                                (click)="submitTestimonial()" 
                                [disabled]="!newTestimonialContent.trim() || isLoading()" 
                                class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition disabled:opacity-50">
                                Submit Feedback for Approval
                            </button>
                            <div *ngIf="submissionMessage()" class="mt-3 p-3 text-sm rounded-lg" [ngClass]="{'bg-green-100 text-green-800': submissionMessage().includes('Thank you'), 'bg-red-100 text-red-800': submissionMessage().includes('Error')}">
                                {{ submissionMessage() }}
                            </div>
                        </div>

                        <!-- Your Submitted Testimonials -->
                        <div class="space-y-4 p-6 bg-white rounded-xl shadow">
                            <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Your Submitted Feedback</h3>
                            <div *ngIf="userTestimonials().length === 0" class="p-3 bg-gray-100 rounded-lg text-gray-600">
                                You have not submitted any testimonials yet.
                            </div>
                            <div *ngFor="let t of userTestimonials()" class="p-3 border border-gray-200 rounded-lg">
                                <p class="italic text-gray-700 mb-2">"{{ t.content }}"</p>
                                <span *ngIf="t.isApproved" class="text-xs font-semibold px-2 py-0.5 bg-green-100 text-green-800 rounded-full">Approved</span>
                                <span *ngIf="!t.isApproved" class="text-xs font-semibold px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full">Pending Review</span>
                            </div>
                        </div>
                    </div>


                    <!-- Data Grid Tab -->
                    <div *ngIf="mainTab() === 'data-grid'" class="space-y-4">
                        <div class="flex flex-wrap items-center space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <!-- Import/Export Buttons -->
                            <button (click)="importJsonFile()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Import JSON File</button>
                            <button (click)="exportJsonFile()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">Export Results (JSON)</button>
                            
                            <!-- API Import/Export (Enterprise Feature) -->
                            <ng-container *ngIf="canUseApi()">
                                <button (click)="importDataFromApi()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">Import Data via REST API</button>
                                <button (click)="exportDataToApi()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">Export Data via REST API</button>
                            </ng-container>

                            <!-- Data Manipulation Buttons -->
                            <button (click)="addRow(null)" [disabled]="!dataRows().length" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition disabled:opacity-50">Insert Row</button>
                            <button (click)="replicateRow()" [disabled]="!dataRows().length || !selectedRowId()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg shadow hover:bg-yellow-600 transition disabled:opacity-50">Replicate Selected</button>
                            <button (click)="deleteRow()" [disabled]="!selectedRowId()" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition disabled:opacity-50">Delete Selected</button>

                            <div *ngIf="dataRows().length" class="ml-auto flex items-center space-x-2">
                                <span class="font-semibold text-gray-700">Sort:</span>
                                <button (click)="clearSort()" class="px-3 py-1 text-sm bg-gray-200 rounded-lg hover:bg-gray-300 transition">Clear Sort</button>
                            </div>
                        </div>

                        <!-- Column Visibility and Key Configuration -->
                        <div *ngIf="dataRows().length" class="p-4 bg-gray-50 rounded-lg shadow-sm">
                            <h3 class="text-md font-semibold text-gray-700 mb-2">Column Configuration</h3>
                            <div class="flex flex-wrap gap-4">
                                <div *ngFor="let col of columnConfig()" class="flex items-center space-x-1 text-sm">
                                    <input type="checkbox" 
                                        [name]="'visible_' + col.name" 
                                        [checked]="col.isVisible" 
                                        (change)="toggleColumnVisibility(col.name, $event)" 
                                        [disabled]="col.isUniqueKey" 
                                        class="text-indigo-600 rounded">
                                    <span class="text-gray-700">{{ col.name }}</span>
                                    
                                    <input type="checkbox" 
                                        [name]="'unique_' + col.name" 
                                        [checked]="col.isUniqueKey" 
                                        (change)="toggleUniqueKey(col.name, $event)" 
                                        class="ml-2 text-red-600 rounded">
                                    <span class="text-red-600 text-xs font-medium">Key</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Unique Key columns must remain visible.</p>
                        </div>
                        
                        <!-- Data Grid -->
                        <div class="data-grid-container shadow-xl rounded-xl border border-gray-200">
                            <table *ngIf="dataRows().length" class="data-grid bg-white">
                                <thead>
                                    <tr cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="dropColumn($event)">
                                        <th class="w-12 sticky left-0 z-10 bg-gray-700 text-white">#</th>
                                        <th *ngFor="let col of columnConfig()" 
                                            [ngStyle]="{'display': col.isVisible ? 'table-cell' : 'none'}" 
                                            (click)="sortData(col.name)"
                                            cdkDrag 
                                            [cdkDragData]="col.name">
                                            <div class="flex items-center justify-between">
                                                <span>{{ col.name }}</span>
                                                <div class="ml-2">
                                                    <ng-container *ngIf="col.isSortAsc !== null">
                                                        <span class="text-xs text-yellow-300 mr-1">({{ col.sortOrder + 1 }})</span>
                                                        <svg *ngIf="col.isSortAsc" class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                                        <svg *ngIf="!col.isSortAsc" class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                                    </ng-container>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="w-12 sticky right-0 z-10 bg-gray-700 text-white">Actions</th>
                                    </tr>
                                </thead>
                                <tbody cdkDropList (cdkDropListDropped)="dropRow($event)">
                                    <tr *ngFor="let row of sortedDataRows(); let i = index" 
                                        [class]="{'bg-indigo-50 selected-row': selectedRowId() === row.id}"
                                        (click)="selectRow(row.id)"
                                        (dblclick)="openDetailModal(row)"
                                        cdkDrag>
                                        <td class="w-12 sticky left-0 bg-white text-gray-500 text-sm drag-handle">
                                            <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                                        </td>
                                        <td *ngFor="let col of columnConfig()" 
                                            [ngStyle]="{'display': col.isVisible ? 'table-cell' : 'none'}"
                                            [class]="{'editable-cell': true, 'font-semibold text-red-600': col.isUniqueKey}">
                                            <input 
                                                type="text" 
                                                [value]="row[col.name]" 
                                                (input)="updateCellValue(row.id, col.name, $event.target.value)"
                                                [name]="'cell_' + row.id + '_' + col.name + i"
                                            >
                                        </td>
                                        <td class="w-12 sticky right-0 z-10 bg-white text-center">
                                            <button (click)="deleteRow(row.id)" class="text-red-500 hover:text-red-700 transition">
                                                <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div *ngIf="!dataRows().length" class="p-8 text-center text-gray-500 bg-white">
                                Import a JSON file or use the REST API import option to begin managing configuration data.
                            </div>
                        </div>
                    </div>


                    <!-- Where Used? Tab (New Feature) -->
                    <div *ngIf="mainTab() === 'where-used'" class="space-y-6">
                        <h2 class="text-3xl font-bold text-indigo-800">Where Used? Configuration Dependency Map</h2>
                        <p class="text-gray-600">Visually map how your **Rule Set** results affect or depend on columns in two external configuration files (Reference 1 and Reference 2).</p>

                        <!-- Map Naming and Description -->
                        <div class="bg-white p-6 rounded-xl shadow space-y-3 border-t-4 border-indigo-500">
                            <h3 class="text-xl font-semibold text-indigo-700">Map Details (Map: {{ whereUsedMapDetails().mapName }})</h3>
                            <input 
                                type="text" 
                                placeholder="Map Name (e.g., Global Job Code Hierarchy Impact)" 
                                [value]="whereUsedMapDetails().mapName" 
                                (input)="updateWhereUsedMapDetail('mapName', $event.target.value)" 
                                class="w-full p-3 border border-gray-300 rounded-lg"
                            >
                            <textarea 
                                placeholder="Map Description (e.g., Trace Job Codes from Rule Set (A) through Employee Data (B) to Team Assignments (C).)" 
                                rows="2" 
                                [value]="whereUsedMapDetails().mapDescription" 
                                (input)="updateWhereUsedMapDetail('mapDescription', $event.target.value)" 
                                class="w-full p-3 border border-gray-300 rounded-lg"
                            ></textarea>
                            <button (click)="saveWhereUsedMap()" [disabled]="!isErdReady()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-bold hover:bg-indigo-600">Save Dependency Map</button>
                        </div>

                        <!-- File Management & Map Generation -->
                        <div class="p-4 bg-gray-50 rounded-xl shadow-sm space-y-4">
                            <h3 class="text-xl font-semibold text-gray-700">File Management</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                
                                <!-- File A: Rule Set Data (Implicitly loaded from Data Grid/Engine) -->
                                <div class="space-y-2">
                                    <p class="font-medium text-gray-700">File A: Rule Set Data (Source)</p>
                                    <div class="file-box bg-indigo-100 border-indigo-500">
                                        <p class="font-bold text-sm mb-1">Rule Set Data ({{ dataRows().length }} rows)</p>
                                        <button (click)="refreshWhereUsedFileA()" class="px-3 py-1 bg-indigo-600 text-white rounded-lg text-xs hover:bg-indigo-700 w-full mt-1">
                                            Refresh Columns
                                        </button>
                                        <p class="text-xs mt-2 text-indigo-800">
                                            Columns: **{{ columnConfig().length }}**
                                        </p>
                                    </div>
                                </div>

                                <!-- File B: Reference 1 -->
                                <div class="space-y-2">
                                    <p class="font-medium text-gray-700">File B: Reference 1</p>
                                    <div class="file-box">
                                        <p class="font-bold text-sm mb-1">{{ whereUsedFiles().B.name }}</p>
                                        <button (click)="importWhereUsedFile('B')" class="px-3 py-1 bg-yellow-600 text-white rounded-lg text-xs hover:bg-yellow-700 w-full mt-1">
                                            Import File B
                                        </button>
                                        <p class="text-xs mt-2" [ngClass]="{'text-green-600': whereUsedFiles().B.keys.length, 'text-red-600': !whereUsedFiles().B.keys.length}">
                                            Columns: **{{ whereUsedFiles().B.keys.length }}**
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- File C: Reference 2 -->
                                <div class="space-y-2">
                                    <p class="font-medium text-gray-700">File C: Reference 2</p>
                                    <div class="file-box">
                                        <p class="font-bold text-sm mb-1">{{ whereUsedFiles().C.name }}</p>
                                        <button (click)="importWhereUsedFile('C')" class="px-3 py-1 bg-yellow-600 text-white rounded-lg text-xs hover:bg-yellow-700 w-full mt-1">
                                            Import File C
                                        </button>
                                        <p class="text-xs mt-2" [ngClass]="{'text-green-600': whereUsedFiles().C.keys.length, 'text-red-600': !whereUsedFiles().C.keys.length}">
                                            Columns: **{{ whereUsedFiles().C.keys.length }}**
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center space-x-4 pt-4 border-t border-gray-300">
                                <button (click)="generateErd()" [disabled]="!isErdReady()" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition disabled:opacity-50">Generate Dependency Map</button>
                                
                            </div>
                        </div>

                        <!-- Search and Grids Area -->
                        <div class="space-y-4">
                             <input type="text" 
                                placeholder="Global Search: Enter value to filter all three files (e.g., 'MGR201')" 
                                [value]="relationalSearchTerm()" 
                                (input)="relationalSearchTerm.set($event.target.value)"
                                class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500">

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Grid 1 (File A: Rule Set Data) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-indigo-700">{{ whereUsedFiles().A.name }} - ({{ filteredFileA().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileA().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileA().length > 0 && whereUsedFiles().A.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-indigo-50 sticky top-0">
                                                    <th *ngFor="let key of whereUsedFiles().A.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileA()" class="border-b">
                                                    <td *ngFor="let key of whereUsedFiles().A.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('A', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Grid 2 (File B: Reference 1) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-yellow-700">{{ whereUsedFiles().B.name }} - ({{ filteredFileB().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileB().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileB().length > 0 && whereUsedFiles().B.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-yellow-50 sticky top-0">
                                                    <th *ngFor="let key of whereUsedFiles().B.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileB()" class="border-b">
                                                    <td *ngFor="let key of whereUsedFiles().B.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('B', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Grid 3 (File C: Reference 2) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-red-700">{{ whereUsedFiles().C.name }} - ({{ filteredFileC().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileC().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileC().length > 0 && whereUsedFiles().C.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-red-50 sticky top-0">
                                                    <th *ngFor="let key of whereUsedFiles().C.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileC()" class="border-b">
                                                    <td *ngFor="let key of whereUsedFiles().C.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('C', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Map Naming and ERD (Kept for completeness) -->
                        <div *ngIf="isErdReady()" class="bg-white p-6 rounded-xl shadow space-y-3 border-t-4 border-indigo-500">
                             <h3 class="text-xl font-semibold text-indigo-700">Dependency Map Visualization</h3>
                             <div class="erd-container" #erdContainer>
                                <!-- SVG and Node rendering for ERD goes here -->
                                <svg class="erd-svg" [attr.width]="erdSize().width" [attr.height]="erdSize().height">
                                    <defs>
                                        <marker id="arrowhead-flow" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                                            <polygon points="0 0, 10 5, 0 10" fill="#4f46e5" />
                                        </marker>
                                        <marker id="arrowhead-source" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                                            <polygon points="0 0, 10 5, 0 10" fill="#f59e0b" />
                                        </marker>
                                    </defs>
                                    
                                    <g *ngFor="let node of erDiagramNodes()">
                                        <g *ngFor="let conn of node.connections">
                                            <line *ngIf="getLineCoordinates(node, conn.targetId) as coords"
                                                [attr.x1]="coords.x1" 
                                                [attr.y1]="coords.y1" 
                                                [attr.x2]="coords.x2" 
                                                [attr.y2]="coords.y2" 
                                                [attr.stroke]="conn.type === 'Source' ? '#f59e0b' : conn.type === 'Target' ? '#ef4444' : '#4f46e5'"
                                                stroke-width="2" 
                                                [attr.marker-end]="conn.type === 'Source' ? 'url(#arrowhead-source)' : 'url(#arrowhead-flow)'"
                                            />
                                        </g>
                                    </g>
                                </svg>
                            
                                <!-- Draggable Nodes -->
                                <div *ngFor="let node of erDiagramNodes()" 
                                    [attr.id]="'node-' + node.id"
                                    [class]="'erd-node cdkDrag node-type-' + node.type"
                                    [ngStyle]="{ 'left.px': node.x, 'top.px': node.y }"
                                    (cdkDragMoved)="onNodeDrag($event, node.id)">
                                    <div class="node-title">{{ node.name }}</div>
                                    <div class="text-gray-500">{{ node.type | titlecase }} Data Point</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relational CRTs Tab (Refined Logic) -->
                    <div *ngIf="mainTab() === 'relational-crts'" class="space-y-6">
                        <h2 class="text-3xl font-bold text-indigo-800">Relational CRTs: Configuration Relationship Tools</h2>
                        <p class="text-gray-600">Define and validate complex, named relationships across the Rule Set data (File A) and two reference files (File B and C). Supports Parent-Child-Grandchild dependencies.</p>

                        <!-- Map Naming and Description -->
                        <div class="bg-white p-6 rounded-xl shadow space-y-3 border-t-4 border-indigo-500">
                            <h3 class="text-xl font-semibold text-indigo-700">Map Details (Map: {{ relationalRelationships()[0]?.mapName || 'Untitled Map' }})</h3>
                            <input type="text" placeholder="Map Name (e.g., Global Job Code Hierarchy)" [value]="relationalRelationships()[0]?.mapName || ''" (input)="updateMapDetail('mapName', $event.target.value)" class="w-full p-3 border border-gray-300 rounded-lg">
                            <textarea placeholder="Map Description" rows="2" [value]="relationalRelationships()[0]?.mapDescription || ''" (input)="updateMapDetail('mapDescription', $event.target.value)" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                            <button (click)="saveMap()" [disabled]="relationalRelationships().length === 0" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm hover:bg-indigo-600">Save Map</button>
                        </div>
                        
                        <!-- File Import and Status -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-sm space-y-4">
                            <h3 class="text-xl font-semibold text-gray-700">File Management</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div *ngFor="let fileId of ['A', 'B', 'C']" class="space-y-2">
                                    <p class="font-medium text-gray-700">File {{ fileId }}</p>
                                    <div class="file-box">
                                        <p class="font-bold text-sm mb-1">{{ relationalFiles()[fileId].name }}</p>
                                        <button (click)="importRelationalFile(fileId)" class="px-3 py-1 bg-yellow-600 text-white rounded-lg text-xs hover:bg-yellow-700 w-full mt-1">
                                            Import {{ fileId }} File
                                        </button>
                                        <p class="text-xs mt-2" [ngClass]="{'text-green-600': relationalFiles()[fileId].keys.length, 'text-red-600': !relationalFiles()[fileId].keys.length}">
                                            Columns: {{ relationalFiles()[fileId].keys.length }} | Rows: {{ relationalFiles()[fileId].data.length }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Bar -->
                        <input type="text" 
                                placeholder="Global Search: Enter value to filter all three files (e.g., 'MGR201')" 
                                [value]="relationalSearchTerm()" 
                                (input)="relationalSearchTerm.set($event.target.value)"
                                class="w-full p-3 border-2 border-indigo-300 rounded-xl focus:border-indigo-500">


                        <!-- Relationship Definition -->
                        <div class="bg-white p-6 rounded-xl shadow space-y-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <h3 class="text-xl font-semibold text-indigo-700">Define Relationships (A &rarr; B &rarr; C)</h3>
                                <button (click)="addRelationship()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">Add Relationship</button>
                            </div>

                            <div *ngIf="relationalRelationships().length === 0" class="p-3 text-center text-gray-500 bg-gray-50 rounded-lg">
                                Define relationships to start validation.
                            </div>

                            <div *ngFor="let rel of relationalRelationships(); let i = index" class="border p-3 rounded-lg space-y-2 relative border-l-4 border-indigo-400">
                                <button (click)="removeRelationship(i)" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                                
                                <!-- A -> B Relationship (Tier 1 to Tier 2) -->
                                <div class="grid grid-cols-4 gap-3 items-center border-b pb-2 mb-2">
                                    <span class="font-bold text-xs text-indigo-600 col-span-4">PARENT &rarr; CHILD (A &rarr; B)</span>
                                    
                                    <!-- A Column - New Selector -->
                                    <div class="rel-column-selector col-span-1">
                                        <button 
                                            (click)="openColumnSelector('A', i, 'fileAColumn')" 
                                            [class]="'column-item w-full'">
                                            {{ rel.fileAColumn || 'Select Col A' }}
                                        </button>
                                    </div>
                                    
                                    <!-- Relation A->B -->
                                    <select [value]="rel.fileBRelation" (change)="updateRelationship(i, 'fileBRelation', $event.target.value)" class="p-2 border rounded-lg text-sm">
                                        <option value="1:1">1:1</option>
                                        <option value="1:M">1:M</option>
                                        <option value="M:M">M:M</option>
                                        <option value="0:1">0:1</option>
                                        <option value="0:M">0:M</option>
                                    </select>
                                    
                                    <!-- B Column - New Selector -->
                                    <div class="rel-column-selector col-span-1">
                                        <button 
                                            (click)="openColumnSelector('B', i, 'fileBColumn')" 
                                            [class]="'column-item w-full'">
                                            {{ rel.fileBColumn || 'Select Col B' }}
                                        </button>
                                    </div>
                                    
                                </div>
                                
                                <!-- B -> C Relationship (Tier 2 to Tier 3 - Optional) -->
                                <div class="grid grid-cols-4 gap-3 items-center pt-2">
                                    <span class="font-bold text-xs text-indigo-600 col-span-4">CHILD &rarr; GRANDCHILD (B &rarr; C)</span>
                                    
                                    <!-- B Column (Parent for C) - New Selector -->
                                    <div class="rel-column-selector col-span-1">
                                        <button 
                                            (click)="openColumnSelector('B', i, 'fileBColumn')" 
                                            [class]="'column-item w-full'">
                                            {{ rel.fileBColumn || 'Select Col B' }}
                                        </button>
                                    </div>
                                    
                                    <!-- Relation B->C -->
                                    <select [value]="rel.fileCRelation" (change)="updateRelationship(i, 'fileCRelation', $event.target.value)" class="p-2 border rounded-lg text-sm">
                                        <option value="1:1">1:1</option>
                                        <option value="1:M">1:M</option>
                                        <option value="M:M">M:M</option>
                                        <option value="0:1">0:1</option>
                                        <option value="0:M">0:M</option>
                                    </select>
                                    
                                    <!-- C Column - New Selector -->
                                    <div class="rel-column-selector col-span-1">
                                        <button 
                                            (click)="openColumnSelector('C', i, 'fileCColumn')" 
                                            [class]="'column-item w-full'">
                                            {{ rel.fileCColumn || 'Select Col C' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4 flex justify-end">
                                <button (click)="validateRelationships()" [disabled]="relationalRelationships().length === 0 || !isRelationalDataReady()" class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition disabled:opacity-50">
                                    Run Data Integrity Check
                                </button>
                            </div>
                        </div>

                        <!-- Validation Results -->
                        <div *ngIf="relationalValidationResult().status !== 'IDLE'" class="bg-white p-6 rounded-xl shadow">
                            <h3 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Validation Results (Map: {{ relationalRelationships()[0]?.mapName || 'Untitled' }})</h3>
                            <div [class]="'validation-result ' + (relationalValidationResult().status === 'OK' ? 'validation-ok' : 'validation-error')">
                                Status: {{ relationalValidationResult().status }}
                            </div>
                            <div *ngIf="relationalValidationResult().status === 'ERROR'" class="mt-3 space-y-2">
                                <p class="font-semibold text-red-700">Errors Found ({{ relationalValidationResult().errors.length }}):</p>
                                <ul class="list-disc list-inside text-sm text-red-700">
                                    <li *ngFor="let error of relationalValidationResult().errors">{{ error }}</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Filtered Data Grids -->
                        <div class="space-y-4 pt-6">
                            <h3 class="2xl font-bold text-gray-800 border-b pb-2">Filtered Data Views</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                
                                <!-- Grid 1 (File A) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-indigo-700">{{ relationalFiles().A.name }} - ({{ filteredFileA().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileA().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileA().length > 0 && relationalFiles().A.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-indigo-50 sticky top-0">
                                                    <th *ngFor="let key of relationalFiles().A.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileA()" class="border-b">
                                                    <td *ngFor="let key of relationalFiles().A.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('A', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Grid 2 (File B) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-yellow-700">{{ relationalFiles().B.name }} - ({{ filteredFileB().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileB().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileB().length > 0 && relationalFiles().B.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-yellow-50 sticky top-0">
                                                    <th *ngFor="let key of relationalFiles().B.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileB()" class="border-b">
                                                    <td *ngFor="let key of relationalFiles().B.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('B', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Grid 3 (File C) -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-lg text-red-700">{{ relationalFiles().C.name }} - ({{ filteredFileC().length }} rows)</h4>
                                    <div class="file-box h-64 overflow-y-auto">
                                        <div *ngIf="filteredFileC().length === 0" class="text-center text-gray-500 pt-8">No data found.</div>
                                        <table *ngIf="filteredFileC().length > 0 && relationalFiles().C.keys.length > 0" class="w-full small-grid">
                                            <thead>
                                                <tr class="bg-red-50 sticky top-0">
                                                    <th *ngFor="let key of relationalFiles().C.keys" class="p-2 border-b">{{ key }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let row of filteredFileC()" class="border-b">
                                                    <td *ngFor="let key of relationalFiles().C.keys" 
                                                        class="p-2"
                                                        (dblclick)="openCascadingDetail('C', key, row[key])">
                                                        {{ row[key] }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `,
    styles: [`
            /* GLOBAL STYLES - Modern, clean SaaS look */
            .app-container {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                background: #f4f6fa; /* Light grey SaaS background */
                font-family: 'Inter', sans-serif;
            }
            
            /* DATA GRID STYLING - High contrast, professional */
            .data-grid-container {
                overflow-x: auto;
                max-width: 100vw;
            }
            .data-grid {
                border-collapse: separate;
                border-spacing: 0;
                min-width: 100%;
                /* Use auto layout for better cell fitting unless necessary */
                table-layout: auto; 
                border-radius: 8px;
                overflow: hidden; /* Ensures borders/shadows are contained */
            }
            .data-grid th, .data-grid td {
                padding: 12px 16px;
                border: 1px solid #e0e7ff; /* Lighter border using indigo tint */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .data-grid th {
                background-color: #312e81; /* Deep Indigo Header */
                color: white;
                font-weight: 600;
                cursor: pointer;
                user-select: none;
                position: sticky;
                top: 0;
                z-index: 10;
                transition: background-color 0.2s;
            }
            .data-grid th:hover {
                background-color: #4338ca; /* Lighter Indigo on hover */
            }
            .data-grid tbody tr {
                transition: background-color 0.2s, box-shadow 0.2s;
            }
            .data-grid tbody tr:hover {
                background-color: #eef2ff; /* Very light blue hover */
            }
            .editable-cell input {
                width: 100%;
                height: 100%;
                border: none;
                background-color: transparent;
                padding: 0;
                margin: 0;
                outline: none;
                font-size: 14px;
            }
            .selected-row {
                background-color: #e0e7ff !important; /* Light Indigo for selected row */
                box-shadow: 0 0 5px rgba(49, 46, 129, 0.2);
            }
            
            /* MODAL STYLING */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 50;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(8px); /* Sharper blur for modern feel */
            }
            .payment-modal-content, .detail-modal-content, .cascading-modal-content, .column-selector-modal-content {
                background-color: white;
                border-radius: 16px; /* Increased radius */
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); /* Deeper shadow */
                padding: 40px;
                max-width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                z-index: 51;
            }
            .cascading-modal-content {
                max-width: 900px; /* Wider for cascading data */
            }
            .column-selector-modal-content {
                max-width: 500px; /* Width for column selector */
            }
            .grid-tab-content {
                height: calc(100vh - 150px); 
                overflow-y: auto;
                padding: 16px 0; /* Adjusted padding */
            }
            
            /* ADMIN GRID STYLING */
            .org-admin-grid th {
                background-color: #f1f5f9;
                color: #1e293b;
                font-weight: 700;
                padding: 12px;
            }
            .testimonial-carousel {
                display: flex;
                overflow-x: scroll;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                padding: 16px 0;
            }
            .testimonial-card {
                flex: 0 0 90%;
                scroll-snap-align: start;
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                border-left: 5px solid #4f46e5; /* Accent color */
                margin-right: 20px;
                padding: 24px;
            }
            @media (min-width: 768px) {
                .testimonial-card {
                    flex: 0 0 30%;
                }
            }
            /* DRAG HANDLES */
            .drag-handle {
                cursor: grab;
                color: #94a3b8;
                width: 20px;
                text-align: center;
                padding-right: 8px;
            }
            /* Flow Diagram Styles */
            .flow-box {
                background-color: white;
                border-radius: 16px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                padding: 1rem;
                text-align: center;
                font-weight: 600;
                min-height: 100px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid #4f46e5;
                font-size: 0.9rem;
            }
            
            /* Flow Diagram Styles */
            .flow-wrapper {
                position: relative;
                display: grid;
                grid-template-columns: 1fr 40px 1fr 40px 1fr 40px 1fr;
                grid-template-rows: 1fr 30px 1fr; /* Top step, middle row, bottom step */
                gap: 0;
                align-items: center;
                justify-content: center;
                margin: 2rem 0;
            }
            
            /* Mobile/Vertical Flow Connector */
            .arrow-vertical-down {
                width: 3px;
                height: 20px;
                background-color: #4f46e5;
                margin: 5px 0;
                position: relative;
            }
            .arrow-vertical-down::after {
                content: '';
                position: absolute;
                bottom: -4px;
                left: 50%;
                width: 0;
                height: 0;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 5px solid #4f46e5;
                transform: translateX(-50%);
            }
            /* Hiding SVG elements on mobile for simplicity */
            @media (max-width: 1024px) {
                .flow-wrapper {
                    display: flex;
                    flex-direction: column;
                    align-items: stretch;
                    gap: 1rem;
                    padding: 0 10px;
                }
                .flow-step-vertical { width: 100% !important; }
                .svg-flow-desktop { display: none; }
            }

            /* Custom Desktop Arrows for Diamond Flow (1->2->3->4->1) */
            @media (min-width: 1025px) {
                .flow-wrapper {
                    display: grid;
                    grid-template-rows: 1fr 30px 1fr;
                    grid-template-columns: 1fr 40px 1fr 40px 1fr 40px 1fr;
                    gap: 0;
                }
                .flow-step-vertical {
                    grid-row: unset;
                }
                
                /* Positioning the boxes */
                .flow-wrapper > .flow-step-vertical:nth-child(1) { grid-column: 4; grid-row: 1; } /* Import */
                .flow-wrapper > .flow-step-vertical:nth-child(2) { grid-column: 7; grid-row: 2; } /* Define/Read Edits */
                .flow-wrapper > .flow-step-vertical:nth-child(3) { grid-column: 4; grid-row: 3; } /* Run Engine */
                .flow-wrapper > .flow-step-vertical:nth-child(4) { grid-column: 1; grid-row: 2; } /* Export */
                
                /* Hiding Mobile Flow Connector */
                .flow-diagram-wrapper { display: none !important; }
            }

            /* ERD Styles */
            .erd-container {
                width: 100%;
                height: 500px;
                background-color: #fcfcfd;
                border: 2px solid #e0e7ff;
                border-radius: 12px;
                position: relative;
                overflow: hidden;
            }
            .erd-node {
                position: absolute;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                padding: 10px 15px;
                cursor: grab;
                min-width: 150px;
                z-index: 10;
                font-size: 0.85rem;
                border: 1px solid #c7d2fe;
                transition: box-shadow 0.2s;
            }
            .erd-node:active {
                cursor: grabbing;
                box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
            }
            .node-title {
                font-weight: 700;
                border-bottom: 2px solid #4f46e5;
                padding-bottom: 3px;
                margin-bottom: 5px;
                color: #312e81;
            }
            .node-type-rules { border-left: 5px solid #10b981; }
            .node-type-source { border-left: 5px solid #f59e0b; }
            .node-type-target { border-left: 5px solid #ef4444; }
            
            .erd-svg {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 5;
            }

            /* Relational CRTs Styles */
            .file-box {
                background: #f1f5f9;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                min-width: 200px;
                max-height: 300px;
                overflow-y: auto;
            }
            .validation-result {
                padding: 10px;
                border-radius: 8px;
                margin-top: 15px;
                font-weight: 600;
            }
            .validation-ok {
                background-color: #d1fae5;
                color: #065f46;
            }
            .validation-error {
                background-color: #fee2e2;
                color: #991b1b;
            }
            
            /* Relationship Drag-and-Drop styles */
            .rel-column-selector {
                position: relative;
                display: flex;
                align-items: center;
            }
            .column-item {
                padding: 6px 12px;
                background-color: #eef2ff;
                border: 1px solid #c7d2fe;
                border-radius: 6px;
                cursor: pointer;
                user-select: none;
                transition: background-color 0.1s;
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            .column-item:hover {
                background-color: #dbeafe;
            }
            .column-item.active {
                background-color: #4f46e5;
                color: white;
                font-weight: 600;
                box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            }
            .relationship-link-display {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px;
                background-color: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
            }
            .rel-link-box {
                background-color: #e0e7ff;
                padding: 10px;
                border-radius: 8px;
            }
            
            /* Grid Table for Where Used/CRTs */
            .small-grid th, .small-grid td {
                padding: 6px 8px;
                font-size: 0.75rem;
                border: 1px solid #e0e7ff;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .small-grid th {
                background-color: #312e81;
                color: white;
                position: sticky;
                top: 0;
            }
            /* Specific Column Selectors */
            .column-list-item {
                padding: 8px 12px;
                border-radius: 6px;
                margin-bottom: 4px;
                cursor: pointer;
                transition: background-color 0.1s;
                font-size: 0.9rem;
            }
            .column-list-item:hover {
                background-color: #f1f5f9;
            }
            .column-list-item.selected {
                background-color: #4f46e5;
                color: white;
                font-weight: 600;
            }
            .column-list-item.less-likely {
                 color: #64748b; /* text-slate-500 */
            }
        `],
    changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App implements OnInit, AfterViewInit {
    @ViewChild('erdContainer') erdContainer!: ElementRef;

    // --- DI and Core Setup ---
    // SECURITY/AUTH BYPASS: Auth and DB objects are initialized but most operations are skipped/mocked below.
    private readonly auth: Auth;
    
    // Mock the Firestore client for local operations (if needed, but avoiding it)
    private db: any;

    constructor() {
        // We still need the app initialized for Firebase client library internal calls
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Initialize Firebase services (minimal usage)
        const app = initializeApp(firebaseConfig);
        this.auth = getAuth(app);
        
        // Mock DB initialization since we bypass rules/permissions checks
        // We only mock the collection method structure to avoid runtime errors on usage, but no database interaction happens.
        this.db = {
            collection: (path: string) => ({ doc: (id: string) => ({}) }) 
        };
    }

    // --- Signals & State Management ---

    // UI State
    mainTab = signal<'my-profile' | 'data-grid' | 'engine' | 'api-config' | 'org-admin' | 'support' | 'where-used' | 'landing' | 'register' | 'login' | 'contact' | 'relational-crts'>('landing'); 
    isLoading = signal<boolean>(false);
    loadingMessage = signal<string>('Loading...');
    contactMessageStatus = signal<string>(''); // For contact form feedback

    // Authentication State
    // SECURITY/AUTH BYPASS: Hardcode default state for development access
    authState = signal<AuthState>({
        isAuthenticated: true,
        isAuthReady: true,
        error: null,
        currentView: 'landing', // SETTING INITIAL VIEW TO LANDING
        name: 'Dev Admin',
        email: 'dev@test.com',
        password: '',
        organizationName: 'Test Org (Bypassed)',
        selectedLicenseType: 'Enterprise',
        licensesToPurchase: 1,
        licenseEmails: [],
        isAdditionalPurchase: false,
    });

    // Profile State (The full, stored user profile)
    // SECURITY/AUTH BYPASS: Hardcode max profile access for development/testing
    currentProfile = signal<UserProfile>({
        userId: 'BYPASSED_ADMIN_USER',
        accountId: 'BYPASS-1234',
        organizationName: 'Test Org (Bypassed)',
        name: 'Dev Admin',
        email: 'dev@test.com',
        isAdmin: true, // Always true for admin view testing
        licenseType: 'Enterprise', // Max license for feature testing
        licenseExpires: Date.now() + (365 * 24 * 60 * 60 * 1000),
        assignedLicenses: [
            { seatId: 1, email: 'dev@test.com', licenseType: 'Enterprise' },
            { seatId: 2, email: 'user1@test.com', licenseType: 'Professional' },
        ],
        apiBaseUrl: 'https://mock.ukg.com/api/v2',
        apiAuthToken: 'MOCK_TOKEN',
        apiEnvironment: 'dev',
    });

    // Data Grid State
    dataRows = signal<DataRow[]>([]);
    columnConfig = signal<ColumnConfig[]>([]);
    selectedRowId = signal<string | null>(null);

    // Engine State (IN-MEMORY)
    transformationRules = signal<TransformationRule[]>([]);
    ruleOperators = [
        { label: '=', value: 'eq' }, { label: '!=', value: 'neq' },
        { label: '>', value: 'gt' }, { label: '<', value: 'lt' },
        { label: 'includes', value: 'in' }, { label: 'excludes', value: 'nin' }
    ];

    // API Config State (IN-MEMORY)
    apiConfigList = signal<ApiConfig[]>([]);
    
    // Testimonial State (NOW IN-MEMORY MOCKED)
    pendingTestimonials = signal<Testimonial[]>([]);
    approvedTestimonials = signal<Testimonial[]>([]);
    userTestimonials = computed(() => this.pendingTestimonials().concat(this.approvedTestimonials()).filter(t => t.userId === this.currentProfile().userId));
    newTestimonialContent = '';
    submissionMessage = signal<string>(''); // Changed to signal for use in template

    // Modals
    paymentModalOpen = signal<boolean>(false);
    bulkApiModalOpen = signal<boolean>(false);
    bulkApiResults = signal<{ rowId: string, inputValue: any, responseJson: string }[]>([]);
    
    detailModal = signal<DetailModalState>({
        isOpen: false,
        row: null,
        tab: 'detail',
        apiResponse: '',
        apiConfig: null,
    });
    
    // New: Cascading Detail State
    cascadingDetail = signal<CascadingDetailState>({
        isOpen: false,
        sourceFileId: 'A',
        sourceColumn: '',
        sourceValue: '',
        linkedData: {}
    });
    
    // New: Column Selector State
    columnSelector = signal<ColumnSelectorState>({
        isOpen: false,
        fileId: null,
        relationshipIndex: -1,
        targetField: null,
        searchTerm: '',
        showAllColumns: false,
    });
    
    // Where Used? / ERD State
    // Files A, B, C are used for Where Used? and Relational CRTs
    whereUsedFiles = signal<{[key: string]: RelationalFile}>({
        A: { name: 'File A (Rule Set)', keys: [], data: [], fileId: 'A' },
        B: { name: 'File B (Reference 1)', keys: [], data: [], fileId: 'B' },
        C: { name: 'File C (Reference 2)', keys: [], data: [], fileId: 'C' },
    });
    erDiagramNodes = signal<ErDiagramNode[]>([]);
    whereUsedMapDetails = signal<WhereUsedMapDetails>({ mapName: 'Rule Set Impact Analysis (MOCK)', mapDescription: 'Analyzing how Rule Set columns influence Reference File 1/2.' });
    
    // Mock Container Size State (Used to draw SVG correctly)
    erdSize = signal<{ width: number, height: number }>({ width: 800, height: 500 });
    
    // Relational CRTs State (Sharing same file state as Where Used? for data consistency)
    relationalFiles = computed(() => this.whereUsedFiles());
    relationalRelationships = signal<RelationshipDefinition[]>([]);
    relationalValidationResult = signal<ValidationResult>({ status: 'IDLE', errors: [] });

    // Search Term for Relational CRTs display
    relationalSearchTerm = signal<string>(''); 


    // --- Computed Properties ---

    // Auth View Logic
    isLandingView = computed(() => this.mainTab() === 'landing');
    isLoginView = computed(() => this.mainTab() === 'login');
    isRegisterView = computed(() => this.mainTab() === 'register');
    isAppView = computed(() => ['my-profile', 'data-grid', 'engine', 'api-config', 'org-admin', 'support', 'where-used', 'relational-crts'].some(tab => tab === this.mainTab()));
    isContactView = computed(() => this.mainTab() === 'contact');
    
    // FIX: This now correctly combines login/register views for conditional display
    isAuthView = computed(() => this.isLoginView() || this.isRegisterView()); 

    // License Logic
    licenses: Record<License['type'], License> = {
        Free: { type: 'Free', price: 0.00, features: ['Sort'], canSort: true, canUseEngine: false, canUseApi: false },
        Basic: { type: 'Basic', price: 299.99, features: ['Sort, Row Edit'], canSort: true, canUseEngine: false, canUseApi: false },
        Professional: { type: 'Professional', price: 499.99, features: ['IF/THEN Engine'], canSort: true, canUseEngine: true, canUseApi: false },
        Enterprise: { type: 'Enterprise', price: 999.99, features: ['All Features, REST API, SSO'], canSort: true, canUseEngine: true, canUseApi: true }
    };
    licenseTypes = computed(() => Object.keys(this.licenses) as License['type'][]);

    selectedLicenseDetails = computed(() => this.licenses[this.authState().selectedLicenseType]);
    
    // SECURITY/AUTH BYPASS: Hardcode true for feature checks
    canSort = computed(() => true); 
    canUseEngine = computed(() => true); 
    canUseApi = computed(() => true); 

    licensesToPurchase = computed(() => this.authState().licensesToPurchase);
    licenseEmails = computed(() => this.authState().licenseEmails);


    licensesToPurchaseArray = computed(() => {
        const count = this.authState().licensesToPurchase;
        
        let secondaryCount = 0;
        let startSeat = 1;

        if (this.authState().isAdditionalPurchase) {
             secondaryCount = count;
             startSeat = this.currentProfile().assignedLicenses.length + 1;
        } else {
             secondaryCount = Math.max(0, count - 1);
             startSeat = 2;
        }

        return Array(secondaryCount).fill(0).map((_, i) => ({
            seatIndex: startSeat + i,
            isPrimary: false
        }));
    });

    // Data Grid Logic
    visibleColumns = computed(() => this.columnConfig().filter(col => col.isVisible));
    uniqueKeyColumns = computed(() => this.columnConfig().filter(col => col.isUniqueKey));
    
    sortedDataRows = computed(() => {
        const rows = [...this.dataRows()];
        const sortColumns = [...this.columnConfig()].filter(col => col.isSortAsc !== null).sort((a, b) => a.sortOrder - b.sortOrder);

        if (sortColumns.length === 0) return rows;

        return rows.sort((a, b) => {
            for (const col of sortColumns) {
                const aVal = a[col.name];
                const bVal = b[col.name];
                const asc = col.isSortAsc;

                if (aVal < bVal) return asc ? -1 : 1;
                if (aVal > bVal) return asc ? 1 : -1;
            }
            return 0;
        });
    });
    
    isErdReady = computed(() => {
        // Now checks File A, B, and C keys for where-used map generation
        const files = this.whereUsedFiles();
        // NOTE: We only require the Rule Set Data Grid (dataRows) to be non-empty for the ERD to be generate meaningful data.
        return this.dataRows().length > 0 && files.A.keys.length > 0 && files.B.keys.length > 0 && files.C.keys.length > 0;
    });
    
    isRelationalDataReady = computed(() => {
        const files = this.relationalFiles();
        // Check if all three files have actual data loaded
        return files['A'].data.length > 0 && files['B'].data.length > 0 && files['C'].data.length > 0;
    });
    
    // Tracks the column currently selected for linking (in Relational CRTs)
    selectedRelationalColumn = signal<{ fileId: 'A' | 'B' | 'C', columnName: string } | null>(null);

    // Computed signals for filtered file views on Where Used / CRTs
    filteredFileA = computed(() => this.filterData(this.relationalFiles().A.data, this.relationalSearchTerm(), this.relationalFiles().A.keys));
    filteredFileB = computed(() => this.filterData(this.relationalFiles().B.data, this.relationalSearchTerm(), this.relationalFiles().B.keys));
    filteredFileC = computed(() => this.filterData(this.relationalFiles().C.data, this.relationalSearchTerm(), this.relationalFiles().C.keys));
    
    
    // Column Selector Logic (New Computed Signals)
    currentColumnFile = computed(() => {
        const fileId = this.columnSelector().fileId;
        return fileId ? this.relationalFiles()[fileId] : null;
    });

    allColumns = computed(() => this.currentColumnFile()?.keys || []);

    // Determines if a column has complete data coverage (Likely Used)
    columnDataCoverage = computed(() => {
        const file = this.currentColumnFile();
        if (!file || file.data.length === 0) return {};

        const coverage: { [key: string]: boolean } = {};
        const totalRows = file.data.length;

        file.keys.forEach(key => {
            const filledRows = file.data.filter(row => 
                row[key] !== undefined && row[key] !== null && String(row[key]).trim() !== ''
            ).length;
            coverage[key] = filledRows === totalRows;
        });
        return coverage;
    });

    // Filters all columns based on search term
    filteredColumns = computed(() => {
        const searchTerm = this.columnSelector().searchTerm.toLowerCase();
        const columns = this.allColumns();
        
        if (!searchTerm) return columns;

        return columns.filter(col => col.toLowerCase().includes(searchTerm));
    });

    // Filters the "Likely Used" (100% coverage) columns by search term
    filteredLikelyUsedColumns = computed(() => {
        const coverage = this.columnDataCoverage();
        return this.filteredColumns().filter(col => coverage[col] === true);
    });

    // Filters the "Less Likely" (partial coverage) columns by search term
    filteredLessLikelyColumns = computed(() => {
        const coverage = this.columnDataCoverage();
        return this.filteredColumns().filter(col => coverage[col] === false);
    });


    // --- Initialization ---

    ngOnInit() {
        this.updateLicensesToPurchase(this.authState().licensesToPurchase);
        this.initializeApp();
    }

    // FIX: Implement ngAfterViewInit for ViewChild usage consistency
    ngAfterViewInit() {
        // Ensure initial ERD container size calculation runs if needed
        this.updateErdSize();
        // Add a listener for window resize events to update ERD size
        window.addEventListener('resize', this.updateErdSize.bind(this));
    }
    
    private initializeApp() {
        this.loadingMessage.set('Bypassing authentication and granting max permissions...');
        this.isLoading.set(true);
        
        // SECURITY/AUTH BYPASS: Set initial state to landing view for marketing display
        this.authState.update(state => ({ ...state, isAuthenticated: true, isAuthReady: true, currentView: 'landing' }));

        // Load MOCKED public and private data
        this.initializeMockData(); 

        this.loadingMessage.set('Authentication bypassed. Full access granted.');
        this.isLoading.set(false);
    }
    
    // MOCK: Initialize ALL mock data in memory
    private initializeMockData(): void {
        console.warn("MOCK: Initializing ALL user/public data in memory.");
        
        // 1. Initialize Rules (IN-MEMORY)
        this.transformationRules.set([
            { id: crypto.randomUUID(), name: 'Set Default Shift', conditions: [{ column: 'ShiftCode', operator: 'eq', value: '', logic: 'AND' }], actions: [{ targetColumn: 'ShiftCode', value: 'REGULAR' }] },
            { id: crypto.randomUUID(), name: 'Update Pay Group', conditions: [{ column: 'Location', operator: 'in', value: 'NY,NJ', logic: 'AND' }, { column: 'JobTitle', operator: 'eq', value: 'Manager', logic: 'AND' }], actions: [{ targetColumn: 'PayGroup', value: 'NORTHEAST_MGMT' }] }
        ]);

        // 2. Initialize API Configs (IN-MEMORY)
        this.apiConfigList.set([
            { id: crypto.randomUUID(), columnName: 'EmployeeID', apiName: 'GetEmpDetails', mapToColumn: 'ExternalID' }
        ]);
        
        // 3. Initialize Testimonials (IN-MEMORY)
        this.approvedTestimonials.set([
            { id: 't1', userId: 'mock1', organizationName: 'Global Corp', content: 'ConfigFlow saved us weeks of manual configuration work. Truly essential.', isApproved: true, timestamp: Date.now() - 86400000 },
            { id: 't2', userId: 'mock2', organizationName: 'Regional WFM', content: 'The Rule Set feature is a game-changer for quarterly updates!', isApproved: true, timestamp: Date.now() - 172800000 },
        ]);
        this.pendingTestimonials.set([
            { id: 'p1', userId: 'BYPASSED_ADMIN_USER', organizationName: 'Test Org (Bypassed)', content: 'This test comment is pending approval.', isApproved: false, timestamp: Date.now() }
        ]);
        
        // 4. Initialize Data Grid & Where Used? Data (MOCK)
        this.dataRows.set([
            { id: crypto.randomUUID(), EmployeeID: '1001', ShiftCode: 'DAY', Location: 'NY', JobTitle: 'Manager' },
            { id: crypto.randomUUID(), EmployeeID: '1002', ShiftCode: '', Location: 'CA', JobTitle: 'Analyst' },
        ]);
        this.columnConfig.set([
            { name: 'EmployeeID', isVisible: true, isUniqueKey: true, isSortAsc: null, sortOrder: -1 },
            { name: 'ShiftCode', isVisible: true, isUniqueKey: false, isSortAsc: null, sortOrder: -1 },
            { name: 'Location', isVisible: true, isUniqueKey: false, isSortAsc: null, sortOrder: -1 },
            { name: 'JobTitle', isVisible: true, isUniqueKey: false, isSortAsc: null, sortOrder: -1 },
        ]);
        
        // 5. Initialize Relational Data (MOCK)
        const mockFiles: {[key: string]: RelationalFile} = {
            A: { name: 'File A (Rule Set)', keys: ['JobID', 'Description', 'ExtraData1', 'NullField'], data: [
                { id: 'd1', JobID: 'ENG101', Description: 'Engineer', ExtraData1: 'X', NullField: 'Y' },
                { id: 'd2', JobID: 'MGR201', Description: 'Manager', ExtraData1: 'Y', NullField: '' },
                { id: 'd3', JobID: 'SAL301', Description: 'Sales Associate', ExtraData1: 'Z', NullField: 'Z' },
            ], fileId: 'A' },
            B: { name: 'File B (Reference 1)', keys: ['EmployeeID', 'JobID', 'CostCenter'], data: [
                { id: 'd4', EmployeeID: 'E100', JobID: 'ENG101', CostCenter: 'CC100' },
                { id: 'd5', EmployeeID: 'E101', JobID: 'MGR201', CostCenter: 'CC101' },
                { id: 'd6', EmployeeID: 'E102', JobID: 'MGR201', CostCenter: 'CC101' },
                { id: 'd7', EmployeeID: 'E103', JobID: 'UNKNOWN', CostCenter: 'CC102' }, // Invalid link
            ], fileId: 'B' },
            C: { name: 'File C (Reference 2)', keys: ['TeamID', 'ManagerID', 'JobID'], data: [
                { id: 'd8', TeamID: 'T1', ManagerID: 'MGR201', JobID: 'MGR201' },
                { id: 'd9', TeamID: 'T2', ManagerID: 'ENG101', JobID: 'ENG101' },
            ], fileId: 'C' },
        };
        
        this.whereUsedFiles.set(mockFiles);

        // MOCK: Update Where Used Map Details based on default setup
        // The default initial state is now set in the signal declaration above.
        // this.whereUsedMapDetails.set({
        //      mapName: 'Rule Set Impact Analysis (MOCK)',
        //      mapDescription: 'Analyzing how Rule Set columns influence Reference File 1/2.'
        // });

        this.relationalRelationships.set([
            // Initial relationship defined for the UI state
            { 
                id: crypto.randomUUID(), 
                mapName: 'Job Hierarchy Example', 
                mapDescription: 'Maps Rule Set (A) to Employees (B) and Teams (C) for integrity check.',
                fileAColumn: 'JobID',
                fileBColumn: 'JobID',
                fileBRelation: '1:M', 
                fileCColumn: 'ManagerID',
                fileCRelation: '0:1', 
            },
        ]);
    }
    
    // Account ID generation helper (Minimal usage of this)
    private appId(): string {
        return typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    }

    // --- Navigation & Auth Methods (Simplified/Mocked) ---

    navigateTo(view: AuthState['currentView']): void {
        this.mainTab.set(view);
        this.authState.update(state => ({
            ...state,
            currentView: view,
            error: null,
            isAdditionalPurchase: view === 'register' ? state.isAdditionalPurchase : false,
        }));
        // Since we are checking mainTab in the template, we don't strictly need currentView update logic here,
        // but we keep it clean.
        if (view === 'landing' || view === 'contact' || view === 'login' || view === 'register' || view === 'relational-crts') {
             this.authState.update(s => ({...s, currentView: view}));
        } else {
             this.authState.update(s => ({...s, currentView: 'app'}));
        }
    }
    
    // License Text Helper
    getLicenseOptionText(key: License['type']): string {
        const license = this.licenses[key];
        const priceText = license.price === 0.00 ? 'FREE' : `$${license.price.toFixed(2)}/yr`;
        const featureText = license.features[0];
        return `${license.type} (${priceText}) - Key Feature: ${featureText}`;
    }

    // License Color Helper
    licenseColor(type: License['type']): string {
        switch (type) {
            case 'Free': return 'text-gray-500';
            case 'Basic': return 'text-yellow-600';
            case 'Professional': return 'text-indigo-600';
            case 'Enterprise': return 'text-red-600';
            default: return 'text-gray-500';
        }
    }

    // Auth Form Field Update Handler
    updateAuthField(field: keyof AuthState, value: any): void {
        this.authState.update(state => ({ ...state, [field]: value, error: null }));
    }
    
    // License Selection Update Handler
    updateLicenseDetails(licenseType: License['type']): void {
        this.authState.update(state => ({ ...state, selectedLicenseType: licenseType, error: null }));
    }

    // License Quantity Update Handler
    updateLicensesToPurchase(value: any): void {
        const newCount = parseInt(value, 10);
        if (isNaN(newCount) || newCount < 1) {
            return;
        }

        this.authState.update(state => ({ ...state, licensesToPurchase: newCount }));
        
        const currentEmails = this.authState().licenseEmails;
        
        let targetCount: number;
        let startSeat = 1;

        if (this.authState().isAdditionalPurchase) {
             targetCount = newCount;
             startSeat = this.currentProfile().assignedLicenses.length + 1;
        } else {
             targetCount = Math.max(0, newCount - 1);
             startSeat = 2;
        }

        const newEmails = Array(targetCount).fill(0).map((_, i) => {
            const existing = currentEmails[i];
            const assignedType = this.licenses[this.authState().selectedLicenseType].type; // Simplified license type assignment here

            if (existing) {
                return { email: existing.email, licenseType: assignedType };
            }
            return { email: '', licenseType: assignedType };
        });
        
        this.authState.update(s => ({ ...s, licenseEmails: newEmails }));
    }

    // Update individual license email/type
    updateLicenseEmail(index: number, field: 'email' | 'licenseType', value: any): void {
        this.authState.update(state => {
            const newEmails = [...state.licenseEmails];
            if (newEmails[index]) {
                newEmails[index] = { ...newEmails[index], [field]: value };
            }
            return { ...state, licenseEmails: newEmails };
        });
    }

    private validateEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    handleAuthSubmit(): void { 
        this.authState.update(state => ({ ...state, error: null }));
        
        const { currentView, email, name, password, organizationName, isAdditionalPurchase } = this.authState();

        let isValid = true;
        let errorMessage = null;

        if (currentView === 'register' && !isAdditionalPurchase) {
            if (!name || !organizationName) { isValid = false; errorMessage = 'Name and Organization are required.'; }
        }
        
        if (!email || !password) { isValid = false; errorMessage = errorMessage || 'Email and Password are required.'; }

        const primaryEmail = isAdditionalPurchase ? '' : email;
        const secondaryEmails = this.authState().licenseEmails.map(l => l.email);
        const allEmails = [primaryEmail, ...secondaryEmails].filter(e => e.trim() !== '');

        if (isValid) {
            for (const mail of allEmails) {
                if (!this.validateEmail(mail)) {
                    isValid = false;
                    errorMessage = `License email "${mail}" is not a valid email address.`;
                    break;
                }
            }
        }
            
        if (isValid) {
            if (new Set(allEmails).size !== allEmails.length) {
                isValid = false;
                errorMessage = 'All license email addresses must be unique.';
            }
        }

        if (!isValid) {
             this.authState.update(state => ({ ...state, error: errorMessage }));
             return;
        }


        if (currentView === 'login') {
            this.navigateTo('data-grid');
        } else { 
            this.paymentModalOpen.set(true);
        }
    }

    // AUTH BYPASS: Mocked login and registration processes
    async processPaymentAndRegister(): Promise<void> { 
        this.paymentModalOpen.set(false);
        this.loadingMessage.set('Payment simulated and access granted!');
        this.isLoading.set(true);
        await new Promise(resolve => setTimeout(resolve, 500));
        this.authState.update(state => ({ ...state, currentView: 'app', isAdditionalPurchase: false }));
        this.mainTab.set('org-admin');
        this.isLoading.set(false);
    }

    // Logout function
    async logout(): Promise<void> {
        this.isLoading.set(true);
        this.loadingMessage.set('Resetting state...');
        
        this.authState.set({
            isAuthenticated: true,
            isAuthReady: true,
            error: null,
            currentView: 'landing', 
            name: 'Dev Admin',
            email: 'dev@test.com',
            password: '',
            organizationName: 'Test Org (Bypassed)',
            selectedLicenseType: 'Enterprise',
            licensesToPurchase: 1,
            licenseEmails: [],
            isAdditionalPurchase: false,
        });

        this.currentProfile.set({
            userId: 'BYPASSED_ADMIN_USER',
            accountId: 'BYPASS-1234',
            organizationName: 'Test Org (Bypassed)',
            name: 'Dev Admin',
            email: 'dev@test.com',
            isAdmin: true,
            licenseType: 'Enterprise',
            licenseExpires: Date.now() + (365 * 24 * 60 * 60 * 1000),
            assignedLicenses: [{ seatId: 1, email: 'dev@test.com', licenseType: 'Enterprise' }],
            apiBaseUrl: 'https://mock.ukg.com/api/v2',
            apiAuthToken: 'MOCK_TOKEN',
            apiEnvironment: 'dev',
        });
        
        this.initializeMockData();

        this.isLoading.set(false);
        this.mainTab.set('landing');
    }

    // License Management Action
    handlePurchaseMoreLicenses(): void {
        this.navigateTo('register');
        this.authState.update(s => ({
            ...s, 
            isAdditionalPurchase: true,
            licensesToPurchase: 1, 
        }));
        this.updateLicensesToPurchase(1); 
    }
    
    // Contact Form Mock
    contactSubmit(): void {
        this.contactMessageStatus.set('Sent!');
        console.warn("MOCK: Contact form submitted successfully.");
        setTimeout(() => this.contactMessageStatus.set(''), 3000);
    }
    
    // Generic search filter for relational data
    private filterData(data: DataRow[], searchTerm: string, keys: string[]): DataRow[] {
        if (!searchTerm) {
            return data;
        }
        const term = searchTerm.toLowerCase();
        
        return data.filter(row => 
            keys.some(key => 
                row[key] !== undefined && row[key] !== null && String(row[key]).toLowerCase().includes(term)
            )
        );
    }
    
    // --- Data Grid Methods (Unchanged functionality) ---
    
    importJsonFile(): void {
        this.loadingMessage.set('Parsing JSON file...');
        this.isLoading.set(true);

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) {
                this.isLoading.set(false);
                return;
            }

            try {
                const text = await file.text();
                const json: DocumentData[] = JSON.parse(text);

                if (!Array.isArray(json) || json.length === 0) {
                    throw new Error("File must contain an array of objects.");
                }

                const sampleRow = json[0];
                const columnKeys = Object.keys(sampleRow);
                
                const currentCols = this.columnConfig();
                const newColumns: ColumnConfig[] = columnKeys.map((key, index) => {
                    const existing = currentCols.find(c => c.name === key);
                    return existing || {
                        name: key,
                        isVisible: true,
                        isUniqueKey: index === 0,
                        isSortAsc: null,
                        sortOrder: -1,
                    };
                });
                this.columnConfig.set(newColumns);

                const rowsWithIds: DataRow[] = json.map(row => ({
                    ...row,
                    id: row.id || crypto.randomUUID(),
                }));

                this.dataRows.set(rowsWithIds);
                this.selectedRowId.set(null);
                this.loadingMessage.set(`Successfully imported ${rowsWithIds.length} rows.`);
                this.mainTab.set('data-grid');

            } catch (error) {
                console.error("Import failed:", error);
                this.loadingMessage.set(`Import failed: ${error.message}`);
            } finally {
                this.isLoading.set(false);
            }
        };
        input.click();
    }

    exportJsonFile(): void {
        const exportedRows = this.dataRows().map(row => {
            const { id, ...rest } = row;
            const exported: DocumentData = {};
            this.columnConfig().forEach(col => {
                if (rest[col.name] !== undefined) {
                    exported[col.name] = rest[col.name];
                }
            });
            return exported;
        });

        const jsonString = JSON.stringify(exportedRows, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'configflow_export_' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.warn("Rule set downloaded successfully.");
    }
    
    importDataFromApi(): void {
        console.warn("Mock: Importing data from REST API using configured Base URL and Authentication Token with v2 and pagination settings.");
    }
    
    exportDataToApi(): void {
        console.warn("Mock: Exporting data to REST API using configured Base URL and Authentication Token with v2 and pagination settings.");
    }
    
    selectRow(rowId: string): void {
        this.selectedRowId.set(rowId);
    }

    addRow(sourceRow: DataRow | null): void {
        const newRow: DataRow = { id: crypto.randomUUID() };
        
        this.columnConfig().forEach(col => {
            newRow[col.name] = sourceRow ? sourceRow[col.name] : '';
        });
        
        if (sourceRow && this.uniqueKeyColumns().length > 0) {
            this.uniqueKeyColumns().forEach(col => {
                newRow[col.name] = 'COPY_' + sourceRow[col.name] + '_' + Date.now().toString().slice(-4);
            });
        }

        this.dataRows.update(rows => [newRow, ...rows]);
        this.selectedRowId.set(newRow.id);
    }

    replicateRow(): void {
        const selectedId = this.selectedRowId();
        const sourceRow = this.dataRows().find(r => r.id === selectedId);
        if (sourceRow) {
            this.addRow(sourceRow);
        }
    }

    deleteRow(rowId?: string): void {
        const idToDelete = rowId || this.selectedRowId();
        if (!idToDelete) return;
        
        this.dataRows.update(rows => rows.filter(row => row.id !== idToDelete));
        if (this.selectedRowId() === idToDelete) {
            this.selectedRowId.set(null);
        }
    }
    
    updateCellValue(rowId: string, colName: string, newValue: any): void {
        this.dataRows.update(rows => rows.map(row => {
            if (row.id === rowId) {
                const uniqueKeyCols = this.uniqueKeyColumns();
                if (uniqueKeyCols.some(col => col.name === colName)) {
                    const isDuplicate = rows.some(r => r.id !== rowId && String(r[colName]) === String(newValue));
                    if (isDuplicate) {
                        console.error(`ERROR: Value '${newValue}' for unique key column '${colName}' already exists. Cannot update.`);
                        return row;
                    }
                }
                return { ...row, [colName]: newValue };
            }
            return row;
        }));
    }

    // Sorting
    sortData(columnName: string): void {
        
        this.columnConfig.update(columns => {
            const column = columns.find(c => c.name === columnName);
            if (!column) return columns;

            const newAsc = column.isSortAsc === null ? true : !column.isSortAsc;
            return columns.map(c => ({
                ...c,
                isSortAsc: c.name === columnName ? newAsc : null,
                sortOrder: c.name === columnName ? 0 : -1,
            }));
        });
    }

    clearSort(): void {
        this.columnConfig.update(columns => columns.map(col => ({ ...col, isSortAsc: null, sortOrder: -1 })));
    }

    // Column Configuration
    toggleColumnVisibility(columnName: string, event: Event): void {
        const isChecked = (event.target as HTMLInputElement).checked;
        this.columnConfig.update(columns => columns.map(col => 
            col.name === columnName ? { ...col, isVisible: isChecked } : col
        ));
    }
    
    toggleUniqueKey(columnName: string, event: Event): void {
        const isChecked = (event.target as HTMLInputElement).checked;
        
        this.columnConfig.update(columns => columns.map(col => {
            if (col.name === columnName) {
                const updatedCol = { ...col, isUniqueKey: isChecked };
                if (isChecked) {
                    updatedCol.isVisible = true;
                }
                const currentKeys = columns.filter(c => c.isUniqueKey && c.name !== columnName);
                if (!isChecked && this.dataRows().length > 0 && currentKeys.length === 0) {
                     console.error("ERROR: Cannot remove the last unique key when data rows are present.");
                     return col;
                }
                return updatedCol;
            }
            return col;
        }));
    }

    // Drag and Drop (Columns)
    dropColumn(event: CdkDragDrop<string[]>) {
        this.columnConfig.update(columns => {
            const currentVisible = columns.filter(col => col.isVisible);
            const hidden = columns.filter(col => !col.isVisible);
            
            moveItemInArray(currentVisible, event.previousIndex, event.currentIndex);

            const newColumns = [...currentVisible, ...hidden];
            return newColumns;
        });
    }

    // Drag and Drop (Rows)
    dropRow(event: CdkDragDrop<DataRow[]>) {
        this.dataRows.update(rows => {
            moveItemInArray(rows, event.previousIndex, event.currentIndex);
            return [...rows];
        });
    }

    // --- Transformation Engine Methods (IN-MEMORY) ---

    // Saves a new rule (IN-MEMORY ONLY)
    async addRule(): Promise<void> {
        
        const newRule: TransformationRule = {
            id: crypto.randomUUID(),
            name: `Rule ${this.transformationRules().length + 1}`,
            conditions: [{ column: this.columnConfig()[0]?.name || 'field1', operator: 'eq', value: '', logic: 'AND' }],
            actions: [{ targetColumn: this.columnConfig()[0]?.name || 'field1', value: '' }]
        };
        
        this.transformationRules.update(rules => [...rules, newRule]);
        console.warn(`MOCK DB: Added rule '${newRule.name}' to in-memory store.`);
    }

    // Deletes a rule (IN-MEMORY ONLY)
    async removeRule(index: number): Promise<void> {
        const ruleToDelete = this.transformationRules()[index];
        if (!ruleToDelete) return;
        
        this.transformationRules.update(rules => rules.filter((_, i) => i !== index));
        console.warn(`MOCK DB: Deleted rule '${ruleToDelete.name}' from in-memory store.`);
    }

    // Updates rule conditions/actions (IN-MEMORY ONLY)
    updateRuleCondition(ruleIndex: number, condIndex: number, field: keyof RuleCondition, value: any): void {
        this.transformationRules.update(rels => {
            const newRules = [...rels];
            if (newRules[ruleIndex] && newRules[ruleIndex].conditions[condIndex]) {
                newRules[ruleIndex].conditions[condIndex] = { ...newRules[ruleIndex].conditions[condIndex], [field]: value };
            }
            return newRules;
        });
    }
    
    updateRuleAction(ruleIndex: number, actIndex: number, field: keyof RuleAction, value: any): void {
        if (field === 'targetColumn') {
            const rule = this.transformationRules()[ruleIndex];
            const isDuplicate = rule.actions.some((action, i) => i !== actIndex && action.targetColumn === value);
            if (isDuplicate) {
                console.error(`ERROR: Column '${value}' is already a target in this rule.`);
                return;
            }
        }
        
        this.transformationRules.update(rels => {
            const newRules = [...rels];
            if (newRules[ruleIndex] && newRules[ruleIndex].actions[actIndex]) {
                newRules[ruleIndex].actions[actIndex] = { ...newRules[ruleIndex].actions[actIndex], [field]: value };
            }
            return newRules;
        });
    }

    addRuleCondition(ruleIndex: number): void {
        this.transformationRules.update(rules => {
            const newRules = [...rules];
            const firstColumn = this.columnConfig()[0]?.name || 'field1';
            newRules[ruleIndex].conditions.push({ column: firstColumn, operator: 'eq', value: '', logic: 'AND' });
            return newRules;
        });
    }

    removeRuleCondition(ruleIndex: number, condIndex: number): void {
        this.transformationRules.update(rules => {
            const newRules = [...rules];
            newRules[ruleIndex].conditions = newRules[ruleIndex].conditions.filter((_, i) => i !== condIndex);
            if (newRules[ruleIndex].conditions.length > 0) {
                 newRules[ruleIndex].conditions[0].logic = 'AND';
            }
            return newRules;
        });
    }

    addRuleAction(ruleIndex: number): void {
        this.transformationRules.update(rules => {
            const newRules = [...rules];
            const firstColumn = this.columnConfig()[0]?.name || 'field1';
            newRules[ruleIndex].actions.push({ targetColumn: firstColumn, value: '' });
            return newRules;
        });
    }

    removeRuleAction(ruleIndex: number, actIndex: number): void {
        this.transformationRules.update(rules => {
            const newRules = [...rules];
            newRules[ruleIndex].actions = newRules[ruleIndex].actions.filter((_, i) => i !== actIndex);
            return newRules;
        });
    }
    
    saveRulesToFile(): void {
        const rulesToSave = this.transformationRules().map(rule => {
            const { id, ...rest } = rule;
            return rest;
        });
        
        const jsonString = JSON.stringify(rulesToSave, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'configflow_rule_set_' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.warn("Rule set downloaded successfully.");
    }
    
    loadRulesFromFile(): void {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            try {
                const text = await file.text();
                const json: TransformationRule[] = JSON.parse(text).map((rule: Omit<TransformationRule, 'id'>) => ({
                    ...rule,
                    id: crypto.randomUUID()
                }));

                if (!Array.isArray(json) || json.length === 0 || !json[0].conditions || !json[0].actions) {
                    throw new Error("Invalid Rule Set format. Must be an array of rules with conditions and actions.");
                }

                this.transformationRules.set(json);
                console.warn(`Successfully loaded ${json.length} rules into in-memory store.`);

            } catch (error) {
                console.error("Load rules failed:", error);
            }
        };
        input.click();
    }

    // Rule Application
    applyAllRules(): void {
        this.loadingMessage.set('Applying transformation rules...');
        this.isLoading.set(true);

        const rules = this.transformationRules();
        let rows = [...this.dataRows()];

        rows = rows.map(row => {
            let newRow = { ...row };
            for (const rule of rules) {
                if (this.checkConditions(newRow, rule.conditions)) {
                    newRow = this.applyActions(newRow, rule.actions);
                }
            }
            return newRow;
        });

        this.dataRows.set(rows);
        this.isLoading.set(false);
        console.warn("Transformation complete. Check Data Grid tab for results.");
    }
    
    private checkConditions(row: DataRow, conditions: RuleCondition[]): boolean {
        if (conditions.length === 0) return true;

        let overallResult = true;
        let lastLogic: 'AND' | 'OR' = 'AND';

        for (let i = 0; i < conditions.length; i++) {
            const cond = conditions[i];
            const rowValue = row[cond.column];
            const conditionMet = this.evaluateCondition(rowValue, cond.operator, cond.value);
            const currentLogic = cond.logic || 'AND';

            if (i === 0) {
                overallResult = conditionMet;
            } else {
                if (currentLogic === 'AND') {
                    overallResult = overallResult && conditionMet;
                } else if (currentLogic === 'OR') {
                    overallResult = overallResult || conditionMet;
                }
            }
            lastLogic = currentLogic;
        }

        return overallResult; 
    }
    
    private evaluateCondition(rowValue: any, operator: string, value: string): boolean {
        if (rowValue === undefined || rowValue === null) return false;
        
        const rowString = String(rowValue).toLowerCase();
        const condString = value.toLowerCase();

        switch (operator) {
            case 'eq': return rowString === condString;
            case 'neq': return rowString !== condString;
            case 'gt': return parseFloat(rowString) > parseFloat(condString);
            case 'lt': return parseFloat(rowString) < parseFloat(condString);
            case 'in': 
                if (condString.includes('*')) {
                    const regexString = '^' + condString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\\\*/g, '.*') + '$';
                    const regex = new RegExp(regexString, 'i');
                    return regex.test(rowString);
                }
                return rowString.includes(condString);
            case 'nin': return !rowString.includes(condString);
            default: return false;
        }
    }
    
    private applyActions(row: DataRow, actions: RuleAction[]): DataRow {
        let newRow = { ...row };
        for (const action of actions) {
            const targetCol = action.targetColumn;
            const formula = action.value.trim();

            if (formula.includes('{{') && formula.includes('}}') && formula.match(/[\+\-\*\/]/)) {
                
                try {
                    let expression = formula;
                    
                    const columnNamesInFormula = expression.match(/\{\{\s*(\w+)\s*\}\}/g);

                    if (columnNamesInFormula) {
                        for (const match of columnNamesInFormula) {
                            const colName = match.replace(/\{\{\s*|\s*\}\}/g, '');
                            const colValue = parseFloat(newRow[colName]) || 0;
                            expression = expression.replace(new RegExp(match, 'g'), colValue.toString());
                        }
                    }
                    
                    const result = new Function(`return ${expression}`)();
                    newRow[targetCol] = isFinite(result) ? result : formula;

                } catch (e) {
                    console.error(`Rule action formula failed for column ${targetCol}: ${e}`);
                    newRow[targetCol] = formula;
                }
            } else {
                newRow[targetCol] = formula;
            }
        }
        return newRow;
    }


    // --- API Configuration Methods (IN-MEMORY ONLY) ---
    
    async addApiConfig(): Promise<void> {
        
        const newConfig: ApiConfig = {
            id: crypto.randomUUID(),
            columnName: this.columnConfig()[0]?.name || 'field1',
            apiName: '',
            mapToColumn: '',
        };

        this.apiConfigList.update(configs => [...configs, newConfig]);
        console.warn(`MOCK DB: Added API config '${newConfig.id}' to in-memory store.`);
    }

    async removeApiConfig(index: number): Promise<void> {
        
        const configToDelete = this.apiConfigList()[index];
        if (!configToDelete) return;
        
        this.apiConfigList.update(configs => configs.filter((_, i) => i !== index));
        console.warn(`MOCK DB: Deleted API config '${configToDelete.id}' from in-memory store.`);
    }

    async updateApiConfig(index: number, field: keyof ApiConfig, value: any): Promise<void> {
        
        const configToUpdate = this.apiConfigList()[index];
        if (!configToUpdate) return;
        
        this.apiConfigList.update(configs => configs.map((config, i) =>
            i === index ? { ...config, [field]: value } : config
        ));
        console.warn(`MOCK DB: Updated API config '${configToUpdate.id}' in-memory store.`);
    }

    // --- Row Detail Modal Methods ---

    openDetailModal(row: DataRow): void {
        this.detailModal.set({
            isOpen: false, // Default to closed unless we explicitly run the API lookup
            row: row,
            tab: 'detail',
            apiResponse: '',
            apiConfig: null,
        });
        // Wait a tick to ensure the modal opens after setting state
        setTimeout(() => this.detailModal.update(state => ({ ...state, isOpen: true })), 0);
    }

    closeDetailModal(): void {
        this.detailModal.set({
            isOpen: false,
            row: null,
            tab: 'detail',
            apiResponse: '',
            apiConfig: null,
        });
    }

    setDetailModalTab(tab: 'detail' | 'api'): void {
        this.detailModal.update(state => ({ ...state, tab }));
    }

    setApiLookupColumn(columnName: string): void {
        const config = this.apiConfigList().find(c => c.columnName === columnName) || null;
        this.detailModal.update(state => ({ ...state, apiConfig: config, apiResponse: '' }));
    }

    runSingleRowApiLookup(): void {
        const modalState = this.detailModal();
        const row = modalState.row;
        const apiConfig = modalState.apiConfig;

        if (!row || !apiConfig) return;

        this.loadingMessage.set(`Running API lookup for column '${apiConfig.columnName}'...`);
        this.isLoading.set(true);

        const inputValue = row[apiConfig.columnName];
        
        // Mock API Call
        setTimeout(() => {
            const mockResponse = JSON.stringify({
                status: 'success',
                endpoint: `${this.currentProfile().apiBaseUrl}/${apiConfig.apiName}`,
                queriedValue: inputValue,
                mapField: apiConfig.mapToColumn,
                data: {
                    id: inputValue,
                    employeeName: 'Mock Employee ' + row.id.slice(0, 4),
                    title: 'Manager',
                    isSupervisor: true,
                    lookupTime: new Date().toISOString()
                }
            }, null, 2);

            this.detailModal.update(state => ({ ...state, apiResponse: mockResponse }));
            this.isLoading.set(false);

        }, 1000);
    }
    
    runBulkApiCall(): void {
        const config = this.apiConfigList()[0]; // Use the first config for simplicity
        if (!config || !this.dataRows().length) return;

        this.loadingMessage.set(`Running bulk API lookup for column '${config.columnName}'...`);
        this.isLoading.set(true);
        this.bulkApiResults.set([]); // Clear previous results
        this.bulkApiModalOpen.set(true);

        const uniqueValues = Array.from(new Set(this.dataRows().map(row => row[config.columnName])));

        let completedRequests = 0;
        const totalRequests = Math.min(uniqueValues.length, 5); // Limit to 5 mock requests

        for (let i = 0; i < totalRequests; i++) {
            const value = uniqueValues[i];
            const rowId = this.dataRows().find(r => r[config.columnName] === value)?.id || 'N/A';

            // Mock API Call
            setTimeout(() => {
                const mockResponseData = {
                    status: 'success',
                    value: value,
                    resolvedName: 'Batch Result ' + i,
                    timestamp: Date.now()
                };

                const result = {
                    rowId: rowId,
                    inputValue: value,
                    responseJson: JSON.stringify(mockResponseData, null, 2)
                };
                
                this.bulkApiResults.update(results => [...results, result]);
                completedRequests++;

                if (completedRequests === totalRequests) {
                    this.isLoading.set(false);
                    this.loadingMessage.set('Bulk API call complete.');
                }
            }, 500 * (i + 1));
        }
        
        if (totalRequests === 0) {
            this.isLoading.set(false);
            this.bulkApiModalOpen.set(false);
        }
    }


    // --- Profile Persistence (MOCKED) ---

    async updateProfileField(field: keyof UserProfile, value: any): Promise<void> {
        this.loadingMessage.set('Saving profile changes...');
        this.isLoading.set(true);
        
        this.currentProfile.update(profile => ({ ...profile, [field]: value }));
        
        console.warn(`MOCK DB: Updated profile field '${field}' to '${value}'. Persistence skipped.`);
        this.loadingMessage.set('Profile updated successfully.');
        this.isLoading.set(false);
    }
    
    async saveProfileChanges(): Promise<void> {
        this.loadingMessage.set('Saving all API config fields...');
        this.isLoading.set(true);
        
        console.warn("MOCK DB: API Configuration saved successfully. Persistence skipped.");
        this.loadingMessage.set('API Configuration saved successfully.');
        this.isLoading.set(false);
    }

    // --- Testimonial Methods (NOW IN-MEMORY MOCKED) ---

    async submitTestimonial(): Promise<void> {
        if (!this.newTestimonialContent.trim()) {
            this.submissionMessage.set('Please enter content to submit a testimonial.');
            setTimeout(() => this.submissionMessage.set(''), 5000);
            return;
        }

        this.isLoading.set(true);
        this.loadingMessage.set('Submitting testimonial...');
        
        const newTestimonial: Testimonial = {
            id: crypto.randomUUID(),
            userId: this.currentProfile().userId,
            organizationName: this.currentProfile().organizationName,
            content: this.newTestimonialContent.trim(),
            isApproved: false, 
            timestamp: Date.now(),
        };

        this.pendingTestimonials.update(t => [...t, newTestimonial]);
        this.newTestimonialContent = '';
        this.submissionMessage.set('Thank you! Your testimonial has been submitted and is pending admin review.');
        
        console.warn(`MOCK DB: Submitted testimonial ID ${newTestimonial.id} to in-memory pending list.`);

        this.isLoading.set(false);
        setTimeout(() => this.submissionMessage.set(''), 5000);
    }
    
    async approveTestimonial(id: string): Promise<void> {
        this.isLoading.set(true);
        this.loadingMessage.set('Approving testimonial...');
        
        // Find and move from pending to approved
        let approvedItem: Testimonial | undefined;
        this.pendingTestimonials.update(pending => {
             const index = pending.findIndex(t => t.id === id);
             if (index > -1) {
                 approvedItem = pending[index];
                 return pending.filter(t => t.id !== id);
             }
             return pending;
        });

        if (approvedItem) {
             this.approvedTestimonials.update(approved => [...approved, { ...approvedItem!, isApproved: true }]);
             console.warn(`MOCK DB: Approved testimonial ID ${id}. Moved to in-memory approved list.`);
        }

        this.isLoading.set(false);
    }
    
    async deleteTestimonial(id: string): Promise<void> {
        this.isLoading.set(true);
        this.loadingMessage.set('Deleting testimonial...');
        
        // Remove from both lists
        this.pendingTestimonials.update(pending => pending.filter(t => t.id !== id));
        this.approvedTestimonials.update(approved => approved.filter(t => t.id !== id));

        console.warn(`MOCK DB: Deleted testimonial ID ${id}. Removed from in-memory lists.`);
        this.isLoading.set(false);
    }

    // --- Utility Methods ---
    
    tabClass(tabName: string): string {
        const base = 'inline-block p-4 border-b-2 rounded-t-lg hover:text-indigo-600 hover:border-indigo-300 transition';
        const active = this.mainTab() === tabName 
            ? 'text-indigo-600 border-indigo-600 font-semibold' 
            : 'border-transparent text-gray-500';
        const disabled = '';
        return `${base} ${active} ${disabled}`;
    }
    
    isTabDisabled(tabName: string): boolean {
        return false;
    }

    // --- Where Used? ERD Logic ---

    // File import handler for Where Used? (MOCK)
    importWhereUsedFile(fileId: 'B' | 'C'): void {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            try {
                const text = await file.text();
                const json: DataRow[] = JSON.parse(text);

                if (!Array.isArray(json) || json.length === 0) {
                    throw new Error("File must contain an array of objects.");
                }

                // Use a sample of keys from the first object
                const keys = Object.keys(json[0] || {}).slice(0, 5); 
                let name = `File ${fileId} (Ref ${fileId})`;

                this.whereUsedFiles.update(files => ({
                    ...files,
                    [fileId]: { name: name, keys: keys, data: json, fileId: fileId }
                }));
                
                // Automatically generate ERD visualization after import
                this.generateErd();
                
                console.warn(`MOCK: Loaded ${keys.length} columns for ${fileId} file.`);

            } catch (error) {
                console.error(`Import ${fileId} failed:`, error);
            } finally {
                 // Clear out the selection logic state when a new file is imported
                 this.selectedRelationalColumn.set(null);
            }
        };
        input.click();
    }
    
    refreshWhereUsedFileA(): void {
        // This simulates File A being pulled directly from the current Rule Set (Data) Grid.
        if (this.dataRows().length === 0) {
             console.warn("Rule Set Data Grid is empty. Import data first.");
             return;
        }

        const data = this.dataRows();
        const keys = this.columnConfig().map(c => c.name);
        
        this.whereUsedFiles.update(files => ({
            ...files,
            ['A']: { name: 'File A (Rule Set - LIVE)', keys: keys, data: data, fileId: 'A' }
        }));
        
        this.generateErd();
        console.warn("File A (Rule Set) refreshed from Data Grid.");
    }
    
    // Logic to generate the mock ERD diagram structure
    generateErd(): void {
        const nodes: ErDiagramNode[] = [];
        const files = this.whereUsedFiles();

        // FIX: Ensure all required files have columns before attempting generation
        if (files.A.keys.length === 0 || files.B.keys.length === 0 || files.C.keys.length === 0) {
            this.erDiagramNodes.set([]);
            return;
        }

        // Helper to add nodes
        const addNodes = (fileId: 'A' | 'B' | 'C', keys: string[], startX: number, type: 'rules' | 'source' | 'target') => {
            keys.forEach((col, i) => {
                nodes.push({
                    id: `${fileId}${i + 1}-${col}`,
                    type: type,
                    name: col,
                    x: startX,
                    y: 50 + (i * 80),
                    connections: []
                });
            });
        };
        
        addNodes('A', files.A.keys, 50, 'source'); // File A (Rule Set) on the left
        addNodes('B', files.B.keys, 350, 'rules'); // File B (Reference 1) in the center
        addNodes('C', files.C.keys, 650, 'target'); // File C (Reference 2) on the right


        // MOCK CONNECTION LOGIC (A.JobID -> B.JobID -> C.JobID)
        const mockConnections = [
            { sourceKey: 'JobID', sourceFile: 'A', targetKey: 'JobID', targetFile: 'B', type: 'Target' },
            { sourceKey: 'JobID', sourceFile: 'B', targetKey: 'JobID', targetFile: 'C', type: 'Target' },
        ];
        
        mockConnections.forEach(conn => {
            const sourceNode = nodes.find(n => n.name === conn.sourceKey && n.id.startsWith(conn.sourceFile));
            const targetNode = nodes.find(n => n.name === conn.targetKey && n.id.startsWith(conn.targetFile));

            if (sourceNode && targetNode) {
                sourceNode.connections.push({ targetId: targetNode.id, type: conn.type });
                // Optional back connection for visual clarity
                targetNode.connections.push({ targetId: sourceNode.id, type: conn.type === 'Source' ? 'Target' : 'Source' }); 
            }
        });


        this.erDiagramNodes.set(nodes);
        this.updateErdSize();
        console.log("ERD Generated with Nodes:", nodes);
    }

    // Drag Handler
    onNodeDrag(event: CdkDragMove<any>, nodeId: string): void {
        const element = event.source.getRootElement();
        this.erDiagramNodes.update(nodes => nodes.map(node => {
            if (node.id === nodeId) {
                // Update node position based on the drag event
                node.x = element.offsetLeft;
                node.y = element.offsetTop;
            }
            return node;
        }));
    }

    // Utility to calculate line start/end coordinates for the SVG
    getLineCoordinates(sourceNode: ErDiagramNode, targetNodeId: string): { x1: number, y1: number, x2: number, y2: number } | null {
        const targetNode = this.erDiagramNodes().find(n => n.id === targetNodeId);
        if (!targetNode) return null;

        const nodeWidth = 180; // Approximate node width (from CSS min-width)
        const nodeHeight = 60; // Approximate node height

        let x1 = sourceNode.x + nodeWidth / 2;
        let y1 = sourceNode.y + nodeHeight / 2;

        let x2 = targetNode.x + nodeWidth / 2;
        let y2 = targetNode.y + nodeHeight / 2;
        
        // Connect from the appropriate edge
        if (targetNode.x > sourceNode.x) {
            x1 = sourceNode.x + nodeWidth;
            x2 = targetNode.x;
        } else {
            x1 = sourceNode.x;
            x2 = targetNode.x + nodeWidth;
        }

        return { x1, y1, x2, y2 };
    }

    // MOCK: Dynamically set the SVG size based on the largest node coordinates
    updateErdSize(): void {
        if (!this.erdContainer) return; // FIX: Ensure ViewChild element is defined before accessing nativeElement

        const containerElement = this.erdContainer.nativeElement;
        const currentWidth = containerElement.clientWidth;
        const currentHeight = containerElement.clientHeight;

        const nodes = this.erDiagramNodes();
        
        let maxX = currentWidth;
        let maxY = currentHeight;

        // Calculate max extent needed for the container based on node positions
        if (nodes.length > 0) {
            // Add padding (200px for width, 100px for height)
            const calculatedMaxX = Math.max(...nodes.map(n => n.x + 200)); 
            const calculatedMaxY = Math.max(...nodes.map(n => n.y + 100)); 
            
            // The SVG size must be at least the size of the container, but extendable if nodes are dragged outside the initial view.
            maxX = Math.max(currentWidth, calculatedMaxX);
            maxY = Math.max(currentHeight, calculatedMaxY);
        }

        this.erdSize.set({ 
            width: maxX, 
            height: maxY 
        });
    }

    // --- Where Used? Map Detail Logic ---

    updateWhereUsedMapDetail(field: keyof WhereUsedMapDetails, value: any): void {
        this.whereUsedMapDetails.update(details => ({
            ...details,
            [field]: value
        }));
    }

    saveWhereUsedMap(): void {
        const details = this.whereUsedMapDetails();
        console.warn(`MOCK DB: Where Used Map '${details?.mapName || 'Untitled'}' saved to in-memory store (Persistence skipped).`);
        this.loadingMessage.set(`Dependency Map '${details?.mapName || 'Untitled'}' saved successfully.`);
        this.isLoading.set(true);
        setTimeout(() => this.isLoading.set(false), 800);
    }
    
    // --- Cascading Detail Viewer Logic (NEW) ---

    openCascadingDetail(sourceFileId: 'A' | 'B' | 'C', sourceColumn: string, sourceValue: any): void {
        if (!sourceValue || String(sourceValue).trim() === '') {
            console.warn("Cannot trace: Source value is empty.");
            return;
        }
        
        this.loadingMessage.set('Tracing record dependencies...');
        this.isLoading.set(true);

        const relationships = this.relationalRelationships();
        const files = this.whereUsedFiles();
        const linkedData: CascadingDetailState['linkedData'] = {};
        
        // Trace logic
        
        // 1. Trace from A to B
        if (sourceFileId === 'A') {
            const relationship = relationships[0];
            if (relationship && sourceColumn === relationship.fileAColumn) {
                const foreignKeyColumn = relationship.fileBColumn;
                const targetFile = files['B'];
                
                const linkedRows = targetFile.data.filter(row => String(row[foreignKeyColumn]) === String(sourceValue));
                
                if (linkedRows.length > 0) {
                    linkedData['B'] = { column: foreignKeyColumn, rows: linkedRows };
                    
                    // 2. Cascade trace from B to C using the newly linked B rows
                    const targetCColumn = relationship.fileCColumn;
                    const bKeys = Array.from(new Set(linkedRows.map(row => row[foreignKeyColumn])));
                    
                    const linkedCRows: DataRow[] = files['C'].data.filter(rowC => 
                        bKeys.some(bKey => String(rowC[targetCColumn]) === String(bKey))
                    );

                    if (linkedCRows.length > 0) {
                        linkedData['C'] = { column: targetCColumn, rows: linkedCRows };
                    }
                }
            }
        } 
        // 3. Trace from B to C
        else if (sourceFileId === 'B') {
            const relationship = relationships[0];
            if (relationship && sourceColumn === relationship.fileBColumn) {
                const foreignKeyColumn = relationship.fileCColumn;
                const targetFile = files['C'];
                
                const linkedRows = targetFile.data.filter(row => String(row[foreignKeyColumn]) === String(sourceValue));
                if (linkedRows.length > 0) {
                    linkedData['C'] = { column: foreignKeyColumn, rows: linkedRows };
                }
            }
        }
        // 4. Trace from C to nowhere (End of cascade)
        else if (sourceFileId === 'C') {
            // C has no downstream files in this structure, so no linked data.
        }
        
        setTimeout(() => {
            this.cascadingDetail.set({
                isOpen: true,
                sourceFileId: sourceFileId,
                sourceColumn: sourceColumn,
                sourceValue: sourceValue,
                linkedData: linkedData
            });
            this.isLoading.set(false);
            this.loadingMessage.set('Trace complete.');
        }, 800);
    }
    
    closeCascadingDetailModal(): void {
        this.cascadingDetail.set({
            isOpen: false,
            sourceFileId: 'A',
            sourceColumn: '',
            sourceValue: '',
            linkedData: {}
        });
    }


    // --- Relational CRTs Logic (Including Column Selector) ---

    // File import handler for Relational CRTs (MOCK)
    importRelationalFile(fileId: 'A' | 'B' | 'C'): void {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            try {
                const text = await file.text();
                const json: DataRow[] = JSON.parse(text);

                if (!Array.isArray(json) || json.length === 0) {
                    throw new Error("File must contain an array of objects.");
                }

                // If importing File A (Rule Set Data), update main data grid
                if (fileId === 'A') {
                    // Update main data grid with imported Rule Set data
                    this.dataRows.set(json.map(row => ({ ...row, id: row.id || crypto.randomUUID() })));
                    this.columnConfig.set(Object.keys(json[0] || {}).map(key => ({
                         name: key, isVisible: true, isUniqueKey: key === 'EmployeeID', isSortAsc: null, sortOrder: -1
                    })));
                }

                // Use a sample of keys from the first object
                const keys = Object.keys(json[0] || {}).slice(0, 10); // Use 10 keys for mock scenario
                let name = `File ${fileId} (Ref ${fileId})`;
                if (fileId === 'A') name = 'File A (Rule Set)';
                
                // Add mock data that ensures some columns are "Less Likely" (NullField)
                const dataWithMissingValues = json.map((row, i) => {
                    if (fileId === 'A' && i % 2 === 1) {
                         return { ...row, 'NullField': '' };
                    }
                    if (fileId === 'B' && i % 3 === 0) {
                         return { ...row, 'CostCenter': null };
                    }
                    return row;
                });


                this.whereUsedFiles.update(files => ({
                    ...files,
                    [fileId]: { name: name, keys: keys, data: dataWithMissingValues, fileId: fileId }
                }));
                
                console.warn(`MOCK: Loaded ${keys.length} columns and ${json.length} rows for Relational CRT File ${fileId}.`);

            } catch (error) {
                console.error(`Import Relational File ${fileId} failed:`, error);
            } finally {
                 this.selectedRelationalColumn.set(null);
            }
        };
        input.click();
    }


    // Updates the shared map details (Name/Description) for CRTs
    updateMapDetail(field: keyof RelationshipDefinition, value: string): void {
        this.relationalRelationships.update(rels => {
            if (rels.length === 0) {
                const newRel: RelationshipDefinition = {
                    id: crypto.randomUUID(),
                    mapName: 'Untitled Map',
                    mapDescription: '',
                    fileAColumn: '', fileBColumn: '', fileBRelation: '1:M',
                    fileCColumn: '', fileCRelation: '0:1'
                };
                (newRel as any)[field] = value;
                return [newRel];
            }
            const updatedRels = [...rels];
            (updatedRels[0] as any)[field] = value;
            return updatedRels;
        });
    }

    addRelationship(): void {
        this.relationalRelationships.update(rels => {
            const files = this.relationalFiles();
            const firstRel = rels[0];

            const mapName = firstRel?.mapName || 'Untitled Map';
            const mapDescription = firstRel?.mapDescription || '';

            const newRel: RelationshipDefinition = {
                id: crypto.randomUUID(),
                mapName: mapName,
                mapDescription: mapDescription,
                fileAColumn: files.A.keys[0] || '',
                fileBColumn: files.B.keys[0] || '',
                fileBRelation: '1:M',
                fileCColumn: files.C.keys[0] || '',
                fileCRelation: '0:1',
            };
            
            if (rels.length === 0) {
                 return [newRel];
            }
            return [...rels, newRel];
        });
        this.relationalValidationResult.set({ status: 'IDLE', errors: [] });
    }

    removeRelationship(index: number): void {
        this.relationalRelationships.update(rels => rels.filter((_, i) => i !== index));
        this.relationalValidationResult.set({ status: 'IDLE', errors: [] });
    }
    
    // Updates specific column/relation details using dropdown value change
    updateRelationship(index: number, field: keyof RelationshipDefinition, value: string): void {
        this.relationalRelationships.update(rels => {
            const updatedRels = [...rels];
            (updatedRels[index] as any)[field] = value;
            return updatedRels;
        });
        this.relationalValidationResult.set({ status: 'IDLE', errors: [] });
    }
    
    // Column Selector Modal Handlers (New)
    
    openColumnSelector(
        fileId: 'A' | 'B' | 'C', 
        relationshipIndex: number, 
        targetField: 'fileAColumn' | 'fileBColumn' | 'fileCColumn'
    ): void {
        const file = this.relationalFiles()[fileId];
        if (file.keys.length === 0) {
            console.warn(`File ${fileId} must be imported before selecting columns.`);
            return;
        }
        
        this.columnSelector.set({
            isOpen: true,
            fileId: fileId,
            relationshipIndex: relationshipIndex,
            targetField: targetField,
            searchTerm: '',
            showAllColumns: false,
        });
    }

    closeColumnSelectorModal(): void {
        this.columnSelector.set({
            isOpen: false,
            fileId: null,
            relationshipIndex: -1,
            targetField: null,
            searchTerm: '',
            showAllColumns: false,
        });
    }
    
    updateColumnSelectorSearch(searchTerm: string): void {
        this.columnSelector.update(state => ({ ...state, searchTerm }));
    }
    
    toggleShowAllColumns(show: boolean): void {
        this.columnSelector.update(state => ({ ...state, showAllColumns: show }));
    }

    isColumnSelected(columnName: string): boolean {
        const selector = this.columnSelector();
        if (selector.relationshipIndex === -1 || !selector.targetField) return false;

        const relationship = this.relationalRelationships()[selector.relationshipIndex];
        return relationship && relationship[selector.targetField] === columnName;
    }

    selectColumnFromList(columnName: string): void {
        const selector = this.columnSelector();
        
        if (selector.relationshipIndex === -1 || !selector.targetField) {
            this.closeColumnSelectorModal();
            return;
        }
        
        // Update the relational relationship field
        this.relationalRelationships.update(rels => {
            const updatedRels = [...rels];
            (updatedRels[selector.relationshipIndex] as any)[selector.targetField!] = columnName;
            return updatedRels;
        });
        
        // This simulates the old column selection logic/visual state (kept for consistency)
        this.selectedRelationalColumn.set({ 
            fileId: selector.fileId!, 
            columnName: columnName 
        });

        this.closeColumnSelectorModal();
        this.relationalValidationResult.set({ status: 'IDLE', errors: [] });
    }

    // New: Handle click selection for drag-and-click mapping (simplified for UI consistency)
    selectRelationalColumn(fileId: 'A' | 'B' | 'C', columnName: string): void {
        const currentSelection = this.selectedRelationalColumn();

        if (currentSelection?.fileId === fileId && currentSelection.columnName === columnName) {
            // Deselect if clicking the active column again
            this.selectedRelationalColumn.set(null);
            return;
        }

        if (!currentSelection) {
            // First click: set source
            this.selectedRelationalColumn.set({ fileId, columnName });
            return;
        }

        // Second click: Define link and reset selection
        this.linkRelationalColumns(currentSelection, { fileId, columnName });
        this.selectedRelationalColumn.set(null);
    }
    
    // New: Logic to create or update a relationship link between two selected columns
    private linkRelationalColumns(
        source: { fileId: 'A' | 'B' | 'C', columnName: string }, 
        target: { fileId: 'A' | 'B' | 'C', columnName: string }
    ): void {
        // Ensure source and target are not the same file
        if (source.fileId === target.fileId) {
             console.error("Cannot link columns within the same file.");
             return;
        }
        
        // Determine the link direction (A->B or B->C)
        let sourceColField: keyof RelationshipDefinition = 'fileAColumn';
        let targetColField: keyof RelationshipDefinition = 'fileBColumn';
        
        // Determine which fields in RelationshipDefinition to update based on source/target files
        // A->B link (Rule Set to Ref 1)
        if (source.fileId === 'A' && target.fileId === 'B') {
            sourceColField = 'fileAColumn';
            targetColField = 'fileBColumn';
        } 
        // B->C link (Ref 1 to Ref 2)
        else if (source.fileId === 'B' && target.fileId === 'C') {
             sourceColField = 'fileBColumn'; 
             targetColField = 'fileCColumn';
        } else {
             console.error(`Invalid link direction: Cannot link ${source.fileId} -> ${target.fileId}. Must be A->B or B->C only.`);
             return;
        }


        this.relationalRelationships.update(rels => {
            if (rels.length === 0) {
                 this.addRelationship(); 
                 return rels; 
            }
            
            const updatedRels = [...rels];
            const relIndex = 0; // Always update the first entry for this mock

            // Set the columns based on the determined direction
            (updatedRels[relIndex] as any)[sourceColField] = source.columnName;
            (updatedRels[relIndex] as any)[targetColField] = target.columnName;


            this.relationalValidationResult.set({ status: 'IDLE', errors: [] });
            return updatedRels;
        });

        console.warn(`MOCK: Defined link ${source.fileId}.${source.columnName} -> ${target.fileId}.${target.columnName}`);
    }


    saveMap(): void {
        const details = this.relationalRelationships()[0];
        console.warn(`MOCK DB: Relational Map '${details?.mapName || 'Untitled'}' saved to in-memory store (Persistence skipped).`);
        this.loadingMessage.set(`Relational Map '${details?.mapName || 'Untitled'}' saved successfully.`);
        this.isLoading.set(true);
        setTimeout(() => this.isLoading.set(false), 800);
    }


    // MOCK: Comprehensive Validation Logic
    validateRelationships(): void {
        this.isLoading.set(true);
        this.loadingMessage.set('Running data integrity checks...');
        
        setTimeout(() => {
            const relationships = this.relationalRelationships();
            const files = this.relationalFiles();
            const errors: string[] = [];

            if (!this.isRelationalDataReady()) {
                this.relationalValidationResult.set({ status: 'ERROR', errors: ['Cannot run validation: All configuration files (A, B, C) must be imported with data.'] });
                this.isLoading.set(false);
                return;
            }

            const getFileKeys = (fileId: 'A' | 'B' | 'C', column: string) => new Set(files[fileId].data.map(row => row[column]));
            const isMandatory = (cardinality: string) => cardinality === '1:1' || cardinality === '1:M';
            
            for (const rel of relationships) {
                // Skip validation if map is incomplete
                if (!rel.fileAColumn || !rel.fileBColumn || !rel.fileCColumn) {
                    errors.push(`Relationship Incomplete: Missing column selections in one or more tiers.`);
                    continue; 
                }

                // ------------------------------------------------------------------
                // Tier 1 & 2: A (Parent/Rule Set) -> B (Child/Reference 1)
                const fileAKeys = getFileKeys('A', rel.fileAColumn);
                const fileBForeignKeys = files.B.data.map(row => row[rel.fileBColumn]).filter(v => v !== undefined && v !== null && String(v).trim() !== '');

                if (isMandatory(rel.fileBRelation)) {
                    const missingBKeys = files.B.data.filter(row => !row[rel.fileBColumn] || String(row[rel.fileBColumn]).trim() === '');
                    if (missingBKeys.length > 0) {
                        errors.push(`A->B Mandatory Link Error: ${missingBKeys.length} rows in File B are missing a value in column '${rel.fileBColumn}'.`);
                    }
                }
                
                // Foreign Key Integrity (B's FK must exist in A's Primary Key column)
                fileBForeignKeys.forEach((fk) => {
                    if (!fileAKeys.has(fk)) {
                         errors.push(`A->B Foreign Key Error: Value '${fk}' in File B:${rel.fileBColumn} does not exist in File A:${rel.fileAColumn}.`);
                    }
                });
                
                // Cardinality Check (1:1 checks on B foreign key)
                if (rel.fileBRelation === '1:1') {
                    const fkCounts: { [key: string]: number } = {};
                    fileBForeignKeys.forEach(fk => { fkCounts[fk] = (fkCounts[fk] || 0) + 1; });
                    for (const fk in fkCounts) {
                        if (fkCounts[fk] > 1) {
                            errors.push(`A->B Cardinality Error: Parent key '${fk}' in File A is referenced ${fkCounts[fk]} times in File B (should be 1:1).`);
                        }
                    }
                }
                
                // ------------------------------------------------------------------
                // Tier 2 & 3: B (Parent/Reference 1) -> C (Grandchild/Reference 2)
                const fileBReferenceKeys = getFileKeys('B', rel.fileBColumn); // B now acts as parent
                const fileCForeignKeys = files.C.data.map(row => row[rel.fileCColumn]).filter(v => v !== undefined && v !== null && String(v).trim() !== '');

                if (isMandatory(rel.fileCRelation)) {
                    const missingCKeys = files.C.data.filter(row => !row[rel.fileCColumn] || String(row[rel.fileCColumn]).trim() === '');
                    if (missingCKeys.length > 0) {
                         errors.push(`B->C Mandatory Link Error: ${missingCKeys.length} rows in File C are missing a value in column '${rel.fileCColumn}'.`);
                    }
                }
                
                // Foreign Key Integrity (C's FK must exist in B's Primary Key column)
                fileCForeignKeys.forEach((fk) => {
                    if (!fileBReferenceKeys.has(fk)) {
                         errors.push(`B->C Foreign Key Error: Value '${fk}' in File C:${rel.fileCColumn} does not exist in File B:${rel.fileBColumn}.`);
                    }
                });
                
                // Cardinality Check (1:1 checks on C foreign key)
                if (rel.fileCRelation === '1:1') {
                    const fkCounts: { [key: string]: number } = {};
                    fileCForeignKeys.forEach(fk => { fkCounts[fk] = (fkCounts[fk] || 0) + 1; });
                    for (const fk in fkCounts) {
                        if (fkCounts[fk] > 1) {
                            errors.push(`B->C Cardinality Error: Parent key '${fk}' in File B is referenced ${fkCounts[fk]} times in File C (should be 1:1).`);
                        }
                    }
                }
            }

            if (errors.length > 0) {
                this.relationalValidationResult.set({ status: 'ERROR', errors });
            } else {
                this.relationalValidationResult.set({ status: 'OK', errors: ['All defined relationships are valid.'] });
            }
            
            this.isLoading.set(false);
            console.log('Validation complete. Errors:', errors);

        }, 1500);
    }
}